<!--
    Default Analysis Request results template for Bika LIMS

    All data is available using the analysisrequest dictionary.
    Example for accessing and displaying data:

    <p tal:content="python:analysisrequest['laboratory']['title']"></p>

    or

    <p tal:content="analysisrequest/laboratory/title"></p>

    Take a look to the documentation for more information about
    available data and fields.
    http://github.com/bikalabs/Bika-LIMS/wiki/blablablabal

-->
<tal:report tal:define="analysisrequest python:view.getAnalysisRequest();
                        client          analysisrequest/client;
                        contact         analysisrequest/contact;
                        laboratory      analysisrequest/laboratory;
                        portal          analysisrequest/portal;
                        sample          analysisrequest/sample;
                        batch           analysisrequest/batch;
                        analyses        analysisrequest/analyses;
                        specifications  analysisrequest/specifications;
                        reporter        analysisrequest/reporter;
                        pointsofcapture analysisrequest/points_of_capture;
                        categories      analysisrequest/categories;
                        categanalyses   analysisrequest/categorized_analyses;
                        hasprevresults  analysisrequest/haspreviousresults;
                        reportdrymatter analysisrequest/report_drymatter;
                        remarksenabled  python:view.context.bika_setup.getEnableAnalysisRemarks();">

<!-- Report header -->
<div id="section-header">
    <div id='lab-logo'>
        <a tal:attributes="href laboratory/url">
            <img tal:attributes="src laboratory/logo"/>
        </a>
    </div>
    <div id="accreditation-logo"
        tal:condition="python:laboratory['accredited']==True">
        <img tal:condition="laboratory/accreditation_logo"
             tal:attributes="src string:${portal/absolute_url}/accreditation_logo"/>
        <img tal:condition="laboratory/accreditation_logo"
             tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/AccreditationBodyLogo.png"/>
    </div>
</div>

<!-- Address and Lab info -->
<div id="section-info">
    <table>
        <tr>
            <td id="client-info">
                <table>
                    <tr><td id="client-contact" tal:content="contact/fullname"></td></tr>
                    <tr><td id="client-name" tal:content="client/name"></td></tr>
                    <tr><td id="client-address" tal:content="structure client/address"></td></tr>
                    <tr>
                        <td id="client-email">
                            <a tal:content="contact/email"
                               tal:attributes="url python:'mailto:%s' % contact['email'];"></a>
                        </td>
                    </tr>
                    <tr tal:condition="client/phone">
                        <td id="client-phone">
                            <span i18n:translate="">Phone</span>:
                            <span tal:content="client/phone"></span>
                        </td>
                    </tr>
                    <tr tal:condition="client/fax">
                        <td id="client-fax">
                            <span i18n:translate="">Fax</span>:
                            <span tal:content="client/fax"></span>
                        </td>
                    </tr>
                </table>
            </td>
            <td id="lab-info">
                <table>
                    <tr><td id="lab-title" tal:content='laboratory/title'></td></tr>
                    <tr><td id="lab-address" tal:content='structure laboratory/address'></td></tr>

                    <tr tal:condition="laboratory/url">
                        <td id="lab-URL">
                            <a tal:attributes="href laboratory/url"
                               tal:content="laboratory/url"></a>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>

<!-- Alert section (invalidated ar, etc.) -->
<div id="section-alert" tal:condition="analysisrequest/invalid">
    <span class='emphasize' i18n:translate="">This Analysis Request has been invalidated due to erroneously published results</span><br/>
    <tal:invalidreport tal:condition="analysisrequest/child_analysisrequest">
       <a tal:attributes="href analysisrequest/url;"
          tal:content="analysisrequest/id"></a>&nbsp;
       <span i18n:translate="">has been replaced by</span>&nbsp;
       <a tal:attributes="href analysisrequest/child_analysisrequest/id"
          tal:content="analysisrequest/child_analysisrequest/id"></a>
    </tal:invalidreport>
</div>

<!-- Summary section -->
<div id="section-summary">
    <h1 i18n:translate="">Summary</h1>
    <table>
        <tr>
            <td class="label" i18n:translate="">Request ID</td>
            <td>
                <a tal:content="analysisrequest/id"
                   tal:attributes="href analysisrequest/url;"></a>
            </td>
        </tr>
        <tr>
            <td class="label" i18n:translate="">Sample ID</td>
            <td>
                <a
                   tal:content="sample/id"
                   tal:attributes="href sample/url"></a>
            </td>
        </tr>
        <tr tal:condition="python: batch">
            <td class="label" i18n:translate="">Batch ID</td>
            <td>
                <a tal:content="batch/id"
                   tal:attributes="href batch/url"></a>
            </td>
        </tr>
        <tr tal:condition="python: batch">
            <td class="label" i18n:translate="">Client Batch ID</td>
            <td tal:content="batch/client_batchid"></td>
        </tr>
        <tr>
            <td class="label" i18n:translate="">Client</td>
            <td>
            <a tal:attributes="href client/url"
               tal:content="client/name"></a>
            </td>
        </tr>
        <tr>
            <td class="label" i18n:translate="">Client SID</td>
            <td tal:content="analysisrequest/client_sampleid"></td>
        </tr>
        <tr>
            <td class="label" i18n:translate="">Sample Type</td>
            <td tal:content="sample/sample_type/title"></td>
        </tr>
        <tr>
            <td class="label" i18n:translate="">Specification</td>
            <td tal:content="specifications/title"></td>
        </tr>
        <tr>
            <td class="label" i18n:translate="">Date Received</td>
            <td tal:content="analysisrequest/date_received">2013-05-31 02:02 PM</td>
        </tr>

        <tr>
            <td class="label" i18n:translate="">Date Published</td>
            <td tal:content="analysisrequest/date_published">2013-06-03 12:02 PM</td>
        </tr>
        <tr tal:condition="reporter/username">
            <td class="label" i18n:translate="">Published by</td>
            <td>
                <tal:email tal:condition="reporter/email"
                           tal:define="email reporter/email">
                    (<a tal:content="email"
                       tal:attributes="href string:mailto:${email}"></a>)
                </tal:email>
            </td>
        </tr>
        <tr tal:condition="python: batch and batch.get('labels', None)">
            <td class="label" i18n:translate="">Batch Labels</td>
            <td tal:content="structure python:', '.join(batch.get('labels'))"></td>
        </tr>
    </table>
</div>

<!-- Results section -->
<div id="section-results">
    <h1 i18n:translate="">Results</h1>
    <table>
        <tal:poc tal:repeat="poc python:categanalyses.keys()">
        <h2 tal:content="poc"></h2>
        <tal:cat tal:repeat="cat python:categanalyses.get(poc,{}).keys()">
        <thead>
            <tr>
                <th class="analysis"><span tal:content="string:${cat}">Category</span></th>
                <th tal:condition="hasprevresults" class="previous"><span i18n:translate="">Previous Results</span></th>
                <th class="result"><span i18n:translate="">Result</span></th>
                <th class="dryresult" tal:condition="analysisrequest/report_drymatter"><span i18n:translate="">Dry</span></th>
                <th class="specs"><span i18n:translate="">Value Range</span></th>
                <th class="outofrange"></th>
            </tr>
        </thead>
        <tbody>
            <tal:analyses tal:repeat="analysis python:categanalyses[poc][cat]">
            <tal:analysis tal:define="analysis_css_result python:'outofrange' if analysis['outofrange'] else '';
                            analysis_css_accredited python:'accredited' if analysis['accredited'] else '';
                            analysis_css_retested python:'retested' if analysis['retested'] else '';">
            <tr tal:attributes="class python:'actual %s %s %s' % (analysis_css_result, analysis_css_accredited, analysis_css_retested);">
                <td class="analysis">
                    <span tal:content="analysis/title">Total 25-OHD</span>
                </td>
                <td tal:condition="hasprevresults" class="prev">
                    <span tal:content="analysis/previous_results">1,2,3</span>
                </td>
                <td>
                    <span class="result" tal:content="analysis/formatted_result">23</span>
                    <span class="units" tal:content="analysis/unit|nothing"></span>
                </td>
                <td class="dryresult" tal:condition="python: reportdrymatter and analysis/resultdm">
                    <span tal:content="string:${analysis/resultdm}  ${analysis/unit|nothing}">23</span>
                </td>
                <td class="specs">
                    <span tal:condition="analysis/uncertainty"
                          tal:replace="string:[+/- ${analysis/uncertainty}] "></span>
                    <span tal:replace="python:'(RT) ' if analysis['retested'] else ''"></span>
                    <span tal:replace="analysis/formatted_specs">50 - 60</span>
                </td>
                <td class="outofrange">
                    <span tal:replace="python:'*' if analysis['outofrange'] else ''"></span>
                </td>
            </tr>
            <tr tal:condition="python:remarksenabled==True and analysis['remarks']">
                <td class="remarks" colspan="5"
                    tal:attributes="colspan python: '6' if reportdrymatter else '5';"
                    tal:content="structure analysis/remarks">
                    Quisque sodales quam quis faucibus pretium. Aliquam erat volutpat. Pellentesque vel gravida nibh. Curabitur scelerisque cursus pretium. Mauris sollicitudin, risus vitae tincidunt fringilla, nisi risus consequat dolor, a laoreet dui odio eget elit. Etiam metus orci, sagittis sit amet metus in, tempus viverra ipsum. Nulla sed mi pharetra, hendrerit turpis quis, hendrerit elit. In vel eleifend arcu. Phasellus at imperdiet dui, quis mattis velit. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas.
                </td>
            </tr>
            </tal:analysis>
            </tal:analyses>
            </tbody>
        </tal:cat>
        </tal:poc>
    </table>
</div>

<!-- QC Results section -->
<div id="section-qcresults">
     <!-- TODO -->
</div>

<!--  Remarks section -->
<div id="section-remarks" tal:condition="analysisrequest/remarks">
    <h1 i18n:translate="">Remarks</h1>
    <p tal:content="structure analysisrequest/remarks"></p>
</div>

<!-- Attachments section -->
<div id="section-attachments">
    <!-- TODO -->
</div>

<!-- Signatures section -->
<div id="section-signatures">
    <!-- TODO -->
</div>

<!-- Discreeter section -->
<div id="section-discreeter">
    <div id="discreeter-outofrange" i18n:translate="">* Result out of client specified range.</div>
    <div tal:condition="analysisrequest/report_drymatter" i18n:translate="">Reported as dry matter</div>
    <div tal:condition="analysisrequest/invoice_exclude" i18n:translate="">Not invoiced</div>
    <div tal:condition="laboratory/accredited" i18n:translate="">Methods included in the <tal:block replace="laboratory/accreditation_body" i18n:name="accreditation_body"/> schedule of Accreditation for this Laboratory. Analysis remarks are not accredited</div>
    <div i18n:translate="">Analysis results relate only to the samples tested.</div>
    <div i18n:translate="">This document shall not be reproduced except in full, without the written approval of <tal:block replace="laboratory/title" i18n:name="name_lab"/></div>
    <div tal:define="confidence_level laboratory/confidence"
         tal:condition="confidence_level" i18n:translate="">Test results are at a <tal:block replace="confidence_level" i18n:name="lab_confidence"/>% confidence level</div>
    <div tal:condition="python:'email' in contact['pubpref']" i18n:translate="">Methods of analysis available by clicking on the 'Request' link</div>
</div>

<div class="footer" tal:content="structure analysisrequest/footer"></div>

</tal:report>
