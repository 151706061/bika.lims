<div class="folderlisting-main-table" i18n:domain="bika">
  <input type="hidden" name="sort_on" tal:attributes="value request/sort_on|string:getObjPositionInParent"/>
  <input type="hidden" name="pagenumber" tal:attributes="value view/batch/pagenumber"/>
  <input type="hidden" name="show_all" tal:attributes="value view/show_all"/>
  <input type="hidden" name="orig_template" tal:attributes="value view/viewname"/>
  <input type="hidden" name="paths:list"
    tal:condition="view/selectall"
    tal:repeat="item view/batch/items_not_on_page"
    tal:attributes="value item/path"/>

<metal:listing
  define-macro="folder_listing"
  tal:define="
    nosortclass view/get_nosort_class;
    review_state python:[t for t in view.review_states if t['id'] == request.get('review_state', 'all')][0];
    portal context/@@plone_portal_state/portal;">

<tal:comment replace="nothing">***************
Workflow review state selector
********************************</tal:comment>
    <tal:review_states condition="python: len(view.review_states)>1" repeat="state view/review_states">
      <input class="review_state_filter"
        type="radio"
        name="review_state"
        tal:define="state_id state/id"
        tal:attributes="
          value state_id;
          id state/id;
          checked python:request.get('review_state', 'all') == state_id and 'checked' or None"/>
      <label tal:attributes="for state/id;" tal:content="state/title" i18n:translate=""/>
    </tal:review_states>

<p class="discreet"
  tal:condition="not: view/batch"
    i18n:translate="description_no_visible_items_add_paste">
    There are no items to display.</p>

<p class="discreet"
  id="clear_filters"
  tal:condition="view/filters_in_use">
  <span i18n:translate="clear_filters" class="link">[clear filters]</span></p>

<table class="listing"
  tal:condition="view/items"
  id="listing-table"
  summary="Content listing"
  i18n:attributes="summary summary_content_listing;"
  tal:define="
    colspan python: len(review_state['columns']);
    colspan python: view.show_select_column and colspan + 1 or colspan;
    colspan python: view.show_sort_column and colspan + 1 or colspan;
    colspan python: str(colspan);
    columns view/columns;
    column_list python:review_state['columns']">

  <thead>

<tal:comment replace="nothing">***************
Item multi-select links in this row
********************************</tal:comment>
    <tal:selectrow condition="python: view.items and view.show_select_row">
      <tr tal:condition="not:view/selectcurrentbatch">
        <th tal:attributes="colspan colspan" class="nosort">
          <span i18n:translate="label_select"
                tal:omit-tag="">Select:</span>
            <a i18n:translate="label_all"
               tal:attributes="href view/selectscreen_url"
               id="foldercontents-selectall">All</a>
        </th>
      </tr>
      <tr tal:condition="view/show_select_all_items">
        <th tal:attributes="colspan colspan" class="nosort">
          <span tal:omit-tag="" i18n:translate="tableheading_all_items_selected">
            All <tal:block replace="view/batch/items_on_page" i18n:name="count"/>
            items on this page are selected.
          </span>
          <a tal:attributes="href view/selectall_url"
             id="foldercontents-selectall-completebatch"
             i18n:translate="tableheading_select_all_items">
             Select all
             <tal:block replace="view/batch/size" i18n:name="count"/>
             items in this folder.
          </a>
        </th>
      </tr>
      <tr tal:condition="view/selectall">
        <th tal:attributes="colspan colspan" class="nosort">
          <span tal:omit-tag="" i18n:translate="tableheading_all_items_selected_in_folder">
            All <tal:block replace="view/batch/size" i18n:name="count"/>
            items in this folder are selected.
          </span>
          <a tal:attributes="href view/selectnone_url" i18n:translate="tableheading_clear_selection"
             id="foldercontents-clearselection">Clear selection
          </a>
        </th>
      </tr>
    </tal:selectrow>

<tal:comment replace="nothing">***************
Colum Headers
********************************</tal:comment>
    <tr condition="view/items">
      <th class="nosort column" id="foldercontents-order-column" tal:condition="view/show_sort_column"/>
      <th class="nosort column" tal:condition="view/show_select_column"/>
      <th class="nosort column" tal:repeat="column column_list"
          tal:attributes="id string:foldercontents-${column}-column">
        <span i18n:translate="python:'listingheader_' + view.columns[ column ]['title']">
          <span tal:content="python:view.columns[  column  ]['title']"/>
        </span>
      </th>
    </tr>

<tal:comment replace="nothing">***************
Filters
********************************</tal:comment>
    <tr tal:condition="python: view.items and view.show_filters">
      <th class="nosort column" id="foldercontents-order-column" tal:condition="view/show_sort_column"/>
      <th class="nosort column" tal:condition="view/show_select_column"/>
      <th tal:repeat="column column_list"
          class="nosort column"
          style="margin:0;padding:0 2px 0 2px;"
          tal:attributes="id string:foldercontents-${column}-column-filter">
        <input type="text" class='folderlisting-filter'
          tal:attributes="
            id string:foldercontents-${column}-column-filter-input;
            name string:foldercontents-${column}-column-filter-input;
            value python: view.request.get('foldercontents-'+column+'-column-filter-input', '')"/>
      </th>
    </tr>

    </thead>


    <tbody>
<tal:comment replace="nothing">***************
Table data rows start here
********************************</tal:comment>
    <tal:items tal:repeat="item view/batch">
      <tr tal:condition="python:item.has_key('id')"
          tal:attributes="class item/table_row_class;
            id string:folder-contents-item-${item/UID};
            item_data item/item_data|nothing">

<tal:comment replace="nothing">***************
Draggable column for manually ordering items
********************************</tal:comment>
        <td tal:condition="view/show_sort_column" class="draggable">&nbsp;</td>

<tal:comment replace="nothing">***************
Elements for selecting items
********************************</tal:comment>
        <td tal:condition="view/show_select_column" class="notDraggable">
          <input type="checkbox"
            class="noborder"
            name="paths:list" id="#"
            value="#"
            tal:attributes="
              value   item/path;
              id      string:cb_${item/id};
              checked item/checked;
              alt     python:view.msg_select_item(item);
              title   item/Title;
              uid     item/UID" />
          <input type="hidden"
            name="selected_obj_paths:list"
            value="#"
            tal:attributes="value item/relative_url" />
          <label
            tal:content="item/title_or_id"
            tal:attributes="for string:cb_${item/id}"
            class="hiddenStructure">Item Title</label>
        </td>

<tal:comment replace="nothing">***************
Table cells for each column from
BikaListingView class definition
**********************************************
0 Not interim column or Result column: just print value.
1 interim and editable - input
2 interim not editable - readonly input
3 'Result' and calculation - readonly input
4 'Result' not calculation - input
* Interim OR Result: Unit
*******************************</tal:comment>
        <tal:column tal:repeat="column review_state/columns">
        <td
          style="white-space: nowrap;"
          tal:attributes="
              class python: columns[column].has_key('table_row_class') and columns[column]['table_row_class'] or ''"
          tal:define="
              input_width python:6;
              is_editable python: item.has_key('_allow_edit') and item['_allow_edit'] or False;
              is_interim python: item.has_key(column) and type(item[column]) == type({}) or False;
              is_result python: column == 'Result';">

<!----------------- Editable ----------------->
        <tal:editable condition="is_editable">

<tal:comment replace="nothing">***************
This cell is in an interim_field column, in an editable row.
******************************* </tal:comment>
          <tal:interim_field condition="is_interim">
            <input
                type="text"
                class="analysis_entry"
                tal:attributes="
                    size input_width;
                    uid string:${item/UID};
                    field python:item[column]['id'];
                    value python: item[column]['value'];"/>
            <em class="discreet"
                style="white-space:nowrap;"
                tal:content="python: item[column]['unit']"/>
            <span tal:attributes="
                uid python:item['UID'];
                field python:item[column]['id']"></span>
          </tal:interim_field>

<tal:comment replace="nothing">***************
Any column that is NOT an interim_field
******************************* </tal:comment>
          <tal:not_interim condition="not: is_interim">

<tal:comment replace="nothing">***************
NOT result column
******************************* </tal:comment>
            <tal:not_result tal:condition="not: is_result">
              <a tal:condition="python:item.has_key('links') and item['links'].has_key(column)" href="#"
                 tal:attributes="
                   href python:item['links'][column];
                   class string: ${item/state_class} ${item/type_class};">
                <!--          <img tal:condition="python:view.columns[column].has_key('icon')"
                               tal:attributes="src python:'images/'+view.columns[column]['icon']" />
                  -->
                <strong tal:content="python: item.get(column, '-')"/>
              </a>
              <span
                tal:condition="python:not (item.has_key('links') and item['links'].has_key(column))"
                tal:content="python:item.get(column)"
                tal:attributes="class item/state_class">&nbsp
              </span>
            </tal:not_result>

<tal:comment replace="nothing">***************
Result column
******************************* </tal:comment>
            <tal:result tal:condition="is_result">
              <input
                tal:condition="python: item['_calculation']" readonly="readonly"
                type="text"
                tabindex="1000"
                tal:attributes="
                  field string:Result;
                  uid item/UID;
                  size input_width;
                  value python: item['Result'];"/>
              <input
                tal:condition="python: not item['_calculation']"
                type="text"
                class="analysis_entry"
                tal:attributes="
                  size input_width;
                  uid string:${item/UID};
                  field string:Result;
                  value python: item['Result'];"/>
              <em class="discreet"
                  style="white-space:nowrap;"
                  tal:content="python: item['Unit']"/>
              <span tal:attributes="
                  uid python:item['UID'];
                  field string:Result;"></span>
              <span name='dependencies'
                    tal:attributes="uid python:item['UID'];"></span>
              <span name='formula'
                    tal:condition="python: item['_calculation']"
                    tal:attributes="uid python:item['UID'];"></span>
            </tal:result>
          </tal:not_interim>
        </tal:editable>

<!----------------- Not Editable ----------------->

<tal:comment replace="nothing">***************
The rest is simple; just display column values;
******************************* </tal:comment>

        <tal:not_editable condition="not: is_editable">
          <tal:interim condition="is_interim">
              <span
                tal:content="python:item.get(column)['value']"
                tal:attributes="class item/state_class">&nbsp
              </span>
              <em class="discreet" style="white-space:nowrap;" tal:content="python: item[column]['unit']"/>
          </tal:interim>
          <tal:not_interim condition="not: is_interim">
              <a
                tal:condition="python:item.has_key('links') and item['links'].has_key(column)" href="#"
                tal:attributes="href python:item['links'][column]; class string: ${item/state_class} ${item/type_class};">
                <!--
                <img
                  tal:condition="python:view.columns[column].has_key('icon')"
                  tal:attributes="src python:'images/'+view.columns[column]['icon']" /> -->
                <strong tal:content="python: item.get(column, '-')"/>
              </a>
              <span
                tal:condition="python:not (item.has_key('links') and item['links'].has_key(column))"
                tal:content="python:item.get(column)"
                tal:attributes="class item/state_class">&nbsp
              </span>
          </tal:not_interim>
        </tal:not_editable>

      </td>
      </tal:column>
      </tr>
      </tal:items>
      </tbody>

      <tfoot tal:condition="not:view/within_batch_size">
      <tr tal:condition="not:view/show_all">
        <th class="nosort" tal:attributes="colspan colspan">
          <a tal:attributes="href view/show_all_url"
            i18n:translate="label_show_all"
              id="foldercontents-show-all">Show all <tal:block replace="view/batch/size" i18n:name="count"/> items</a>
              </th>
          </tr>
        <tr tal:condition="view/show_all">
        <th class="nosort" tal:attributes="colspan colspan">
          <a tal:attributes="href view/view_url"
            i18n:translate="label_show_batched"
              id="foldercontents-show-batched">Show batched</a>
              </th>
          </tr>
        </tfoot>
      </table>

      <div tal:replace="structure view/batching"
        tal:condition="python: not view.show_all"/>

      <tal:transitions
        tal:condition="python: review_state.has_key('transitions') and view.items"
          tal:repeat="transition review_state/transitions">
          <input class="context transition_action"
          type="submit"
            name="transition_action"
            tal:attributes="value transition;" />
            </tal:transitions>
        </metal:listing>
      </div>
