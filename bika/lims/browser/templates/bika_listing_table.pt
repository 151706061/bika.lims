<div class="folderlisting-main-table" tal:define="
	nosortclass view/get_nosort_class;
	portal context/@@plone_portal_state/portal;
	review_state python:[t for t in view.review_states
	                     if t['id'] == request.get('review_state', 'all')][0];
	specification python:view.request.get('specification', 'lab');

	sm python:modules['AccessControl'].getSecurityManager();
	EditAnalyses python:sm.checkPermission('BIKA: Edit analyses', context);
	ViewResults python:sm.checkPermission('BIKA: View Results', context);
	user python:sm.getUser();
	roles python:user.getRoles();">

<tal:comment replace="nothing">***************
Workflow review state selector
********************************</tal:comment>
	<tal:review_states
		condition="python:len(view.review_states)>1"
		repeat="state view/review_states">
		<input class="review_state_filter"
			type="radio"
			name="review_state"
			tal:define="state_id state/id"
			tal:attributes="
				value state_id;
				id state/id;
				checked python:request.get('review_state', 'all') == state_id
				               and 'checked' or None"/>
		<label tal:attributes="for state/id;"
		       tal:content="state/title"
			   i18n:translate=""/>
	</tal:review_states>

<p class="discreet"
	tal:condition="not: view/batch"
		i18n:translate="description_no_visible_items_add_paste">
		There are no items to display.</p>

<p class="discreet"
	id="clear_filters"
	tal:condition="view/filters_in_use">
	<span i18n:translate="clear_filters" class="link">[clear filters]</span></p>

<span tal:replace="structure context/@@authenticator/authenticator"/>

<table class="listing"
	tal:condition="view/items"
	id="listing-table"
	summary="Content listing"
	i18n:attributes="summary summary_content_listing;"
	tal:define="
		colspan python:len(review_state['columns']);
		colspan python:view.show_select_column and colspan + 1 or colspan;
		colspan python:view.show_sort_column and colspan + 1 or colspan;
		colspan python:str(colspan);
		columns view/columns;
		column_list python:review_state['columns']">

	<thead>

<tal:comment replace="nothing">***************
Item multi-select links in this row
********************************</tal:comment>
	<tal:selectrow condition="python:view.items and view.show_select_row">
		<tr tal:condition="not:view/selectcurrentbatch">
			<th tal:attributes="colspan colspan" class="nosort">
				<span i18n:translate="label_select"
					tal:omit-tag="">Select:</span>
				<a i18n:translate="label_all"
					tal:attributes="href view/selectscreen_url"
					id="foldercontents-selectall">All</a>
			</th>
		</tr>
		<tr tal:condition="view/show_select_all_items">
			<th tal:attributes="colspan colspan" class="nosort">
				<span tal:omit-tag=""
					i18n:translate="tableheading_all_items_selected">
					All
					<tal:block
						replace="view/batch/items_on_page"
						i18n:name="count"/>
					items on this page are selected.
				</span>
				<a tal:attributes="href view/selectall_url"
					id="foldercontents-selectall-completebatch"
					i18n:translate="tableheading_select_all_items">
					Select all
					<tal:block replace="view/batch/size" i18n:name="count"/>
					items in this folder.
				</a>
			</th>
		</tr>
		<tr tal:condition="view/selectall">
			<th tal:attributes="colspan colspan" class="nosort">
				<span tal:omit-tag=""
					i18n:translate="tableheading_all_items_selected_in_folder">
					All
					<tal:block replace="view/batch/size" i18n:name="count"/>
					items in this folder are selected.
				</span>
				<a tal:attributes="href view/selectnone_url"
					i18n:translate="tableheading_clear_selection"
					id="foldercontents-clearselection">Clear selection
				</a>
			</th>
		</tr>
	</tal:selectrow>

<tal:comment replace="nothing">***************
Colum Headers
********************************</tal:comment>
	<tr condition="view/items">
		<th class="nosort column"
			id="foldercontents-order-column"
			tal:condition="view/show_sort_column"/>
		<th class="nosort column"
			tal:condition="view/show_select_column"/>
		<th class="nosort column"
			tal:repeat="column column_list"
			tal:attributes="id string:foldercontents-${column}-column">
		<span i18n:translate="python:'listingheader_' +
									view.columns[ column ]['title']">
			<span tal:content="python:view.columns[  column  ]['title']"/>
		</span>
		</th>
	</tr>

<tal:comment replace="nothing">***************
Filters
********************************</tal:comment>
	<tr tal:condition="python:view.items and view.show_filters">
		<th class="nosort column"
			id="foldercontents-order-column"
			tal:condition="view/show_sort_column"/>
		<th class="nosort column" tal:condition="view/show_select_column"/>
		<th tal:repeat="column column_list"
			class="nosort column"
			style="margin:0;padding:0 2px 0 2px;"
			tal:attributes="id string:foldercontents-${column}-column-filter">
		<input type="text"
			class='folderlisting-filter'
		tal:attributes="
			id string:foldercontents-${column}-column-filter-input;
			name string:foldercontents-${column}-column-filter-input;
			value python:view.request.get('foldercontents-'+column+
							'-column-filter-input', '')"/>
		</th>
	</tr>

	</thead>

	<tbody>
<tal:comment replace="nothing">*************** TR
Table data rows start here
********************************</tal:comment>
	<tal:items tal:repeat="item view/batch">
		<tr tal:condition="python:item.has_key('id')"
			tal:define="keyword python:item.has_key('Keyword') and
										item['Keyword'] or ''"
			tal:attributes="class item/table_row_class;
				id string:folder-contents-item-${item/uid};
				uid item/uid;
				specs python:item.has_key('specs') and item['specs'] or [];
				keyword keyword;">
		<input type="hidden" tal:attributes="
			name string:InterimFields.${item/uid}:records;
			id string:${item/uid}_item_data;
			value item/item_data|nothing;"/>

<tal:comment replace="nothing">***************
Draggable column for manually ordering items
********************************</tal:comment>
	<td tal:condition="view/show_sort_column" class="draggable">
	 <tal:block tal:define="quoted_id python:item['obj'].UID();">
	  <a href=""
		 title="Move item up"
		 i18n:attributes="title title_move_item_up;"
		 tal:attributes="href string:${view/base_url}/folder_position?position=up&amp;id=${quoted_id}">
		&#9650;
	  </a>
	  <a href=""
		 title="Move item down"
		 i18n:attributes="title title_move_item_down;"
		 tal:attributes="href string:${view/base_url}/folder_position?position=down&amp;id=${quoted_id}">
		&#9660;
	  </a>
	 </tal:block>
	</td>

<tal:comment replace="nothing">***************
Item select checkboxes.
********************************</tal:comment>
	<td tal:condition="view/show_select_column"
		tal:attributes="class string:notDraggable ${item/state_class}">
		<input type="checkbox"
			class="noborder"
			name="paths:list" id="#"
			value="#"
			tal:attributes="
				value   item/path;
				id      string:cb_${item/id};
				checked item/checked;
				alt     python:view.msg_select_item(item);
				uid     item/uid" />
		<input type="hidden"
			name="selected_obj_paths:list"
			value="#"
			tal:attributes="value item/relative_url" />
		<label
			tal:content="item/title"
			tal:attributes="for string:cb_${item/id}"
			class="hiddenStructure">Item Title</label>
	</td>

<tal:comment replace="nothing">***************  TD.
Table cells for each column from in review_state's column list.
********************</tal:comment>

	<tal:cell
		tal:repeat="column review_state/columns">

	<td
		style="white-space: nowrap;"
		tal:define="
			input_width python:5;
			allow_edit python:column in item['allow_edit'];
			before python:column in item['before'] and
				item['before'][column] or '';
			after python:column in item['after'] and
				item['after'][column] or '';
			replace python:column in item['replace'] and
				item['replace'][column] or '';
			field_type python:'type' in columns[column] and
				columns[column]['type'] or 'string';
			table_row_class python:'table_row_class' in columns[column] and
				columns[column]['table_row_class'] or '';
			class python:column in item['class'] and
				item['class'][column] or '';"
		tal:attributes="
			class string:$table_row_class $class ${item/state_class}">

	<!-- before structure -->
	<tal:before
		tal:replace="structure before"/>

	<!-- replace structure -->
	<tal:before
		tal:replace="structure replace"/>

	<span tal:omit-tag
		tal:condition="not:replace">
	<span tal:omit-tag
		tal:condition="python:field_type == 'string'">		<!-- string -->
		<!-- interim field -->
		<span tal:omit-tag
			tal:condition="python:type(item[column]) == type({})">
			<!-- edit -->
			<input
				type="text"
				class="listing_string_entry"
				tal:condition="python:allow_edit"
				tal:attributes="
					size input_width;
					uid string:${item/uid};
					field python:column;
					value python:item[column]['value'];"/>
			<!-- view -->
			<span
				tal:condition="python:not allow_edit"
				tal:content="python:item[column]['value']"
				tal:attributes="class item/state_class"/>
			<input
				type="hidden"
				tal:condition="python:not allow_edit"
				tal:attributes="
					size input_width;
					uid string:${item/uid};
					field python:column;
					value python:item[column]['value'];"/>
		</span>
		<!-- regular field -->
		<span tal:omit-tag
			tal:condition="python:type(item[column]) != type({}) and
							not (column == 'Result' and item['calculation'])">
			<!-- edit -->
			<input
				type="text"
				tal:condition="python:allow_edit"
				class="listing_string_entry"
				tal:attributes="
					size input_width;
					uid string:${item/uid};
					field python:column;
					name string:${column}.${item/uid}:records;
					value python:item[column] and
									item[column] or '';"/>
			<!-- view -->
			<span
				tal:condition="python:not allow_edit and column == 'Result'"
				tal:content="python:item['formatted_result'] and item['formatted_result'] or item[column]"
				tal:attributes="class item/state_class"/>
			<span
				tal:condition="python:not allow_edit and column != 'Result'"
				tal:content="python:item[column] and item[column] or ''"
				tal:attributes="class item/state_class"/>
			<input
				type="hidden"
				tal:condition="python:not allow_edit"
				tal:attributes="
					size input_width;
					uid string:${item/uid};
					field python:column;
					name string:${column}.${item/uid}:records;
					value python:item[column];"/>
		</span>
		<!-- calculated result field. -->
		<span tal:omit-tag
			tal:condition="python:column == 'Result' and
								item['calculation']">
			<span
				tal:condition="python:ViewResults"
				tal:attributes="
					field string:formatted_result;
					uid item/uid;
					size input_width;"
				tal:content="python:item['Result']"/>
			<input
				tal:condition="python:ViewResults"
				type="hidden"
				tal:attributes="
					uid string:${item/uid};
					field string:Result;
					name string:Result.${item/uid}:records;
					value python:item['Result'];"/>
		</span>

	</span>

	<span tal:omit-tag
		tal:condition="python:field_type == 'boolean'">		<!-- boolean -->
		<input
			type="checkbox"
			tal:condition="allow_edit"
			tal:attributes="
				class item/state_class;
				uid string:${item/uid};
				id python:'%s-%s' % (item['uid'], column);
				name string:${column}.${item/uid}:record:ignore-empty;
				checked python:item.get(column) and 'yes' or '';"/>
		<!-- will not display if readonly and false -->
		<input
			type="checkbox"
			tal:condition="python:not allow_edit and item.get(column)"
			disabled="disabled"
			tal:attributes="
				class item/state_class;
				checked python:item.get(column) and 'yes' or '';"/>
	</span>

	<span tal:omit-tag
		tal:condition="python:field_type == 'choices'">		<!-- choices -->
		<span tal:condition="allow_edit">
			<select
				tal:condition="python:column in item['choices']"
				tal:attributes="
					field string:column;
					name string:${column}.${item/uid}:records;
					uid item/uid;">
				<option value=""></option>
				<tal:options tal:repeat="option python:item['options'][column]">
					<option
						tal:attributes="
							value option;
							selected python:item[column] == option
											and 'selected' or '';"
						tal:content="option">
					</option>
				</tal:options>
			</select>
		</span>
		<span tal:omit-tag
			tal:condition="not:allow_edit">
			<span
				tal:content="python:item.get(column) and item.get(column) or ''"
				tal:attributes="class string:${item/state_class} result"/>
			<input
				type="hidden"
				tal:condition="not:allow_edit"
				tal:attributes="
					size input_width;
					uid string:${item/uid};
					field python:column;
					value python:item[column];"/>
		</span>
	</span>

	<!-- unit for interim and result-->
	<em tal:condition="python:'Unit' in item and
							(column == 'Result' or
								column in item['interim_fields'])"
		class="discreet"
		style="white-space:nowrap;"
		tal:content="python:item['Unit']"/>

	<!-- alert container -->
	<span class="alert" tal:attributes="
		uid python:item['uid'];
		field column;">
		<!-- initial out-of-range indicators -->
		<img
			tal:condition="python:column == 'Result' and
			                      item['Result'] and
								  not item['result_in_range']"
			tal:attributes="uid item/uid;"
			src='++resource++bika.lims.images/exclamation.png'
			i18n:attributes="title"
			title="Result out of range"
			icon="exclamation"/>
		<img
			tal:condition="python:column == 'Result' and
									item['Result'] and
									item['result_in_range'] == '1'"
			tal:attributes="uid item/uid;"
			src='++resource++bika.lims.images/warning.png'
			i18n:attributes="title"
			title="Result out of range: in error shoulder"
			icon="warning"/>
	</span>
	</span> <!-- </span tal:condition="not:replace"> -->

	<!-- after structure -->
	<tal:after
		tal:replace="structure after"/>

	</td>
	</tal:cell>


	</tr>
	</tal:items>
</tbody>

<tfoot tal:condition="not:view/within_batch_size">
	<tr tal:condition="not:view/show_all">
		<th class="nosort" tal:attributes="colspan colspan">
			<a
				tal:attributes="href view/show_all_url"
				i18n:translate="label_show_all"
				id="foldercontents-show-all">
				Show all
				<tal:block replace="view/batch/size" i18n:name="count"/>
				items</a>
		</th>
	</tr>
	<tr tal:condition="view/show_all">
		<th class="nosort" tal:attributes="colspan colspan">
			<a tal:attributes="href view/view_url"
				i18n:translate="label_show_batched"
					id="foldercontents-show-batched">Show batched</a>
		</th>
	</tr>
	</tfoot>
</table>

<div tal:replace="structure view/batching"
	tal:condition="python:not view.show_all"/>

<span class="workflow_action_buttons"
	tal:define="actions view/get_workflow_actions">
	<span tal:omit-tag tal:repeat="action actions">
		<input
			class="context workflow_action_button"
			type="submit"
			name="workflow_action_button"
			tal:attributes="
				value action/id;"/>
	</span>
</span>

</div>
