<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">
<head><title></title></head>

<body>

<div metal:fill-slot="main"
  tal:define="
        portal context/@@plone_portal_state/portal;
        member python:here.portal_membership.getAuthenticatedMember();
        lab_accredited python:context.bika_settings.laboratory.getLaboratoryAccredited();
        sample here/getSample;
        sampletype sample/getSampleType;
        sampletype_uid sampletype/UID;
        profile python:here.getProfile() and here.getProfile().getProfileTitle() or '';
        global tf python:0;
        global out_of_range python:0;
        global dry_matter python:here.getReportDryMatter() and 1 or 0;
        global late python:0;
        client nocall:here/aq_parent;
        client_uid client/UID;
        member_groups python: [here.portal_groups.getGroupById(group.id).getGroupName() for group in here.portal_groups.getGroupsByUserId(member.id)];
        is_client python: 'clients' in member_groups;
        default_spec python:is_client and 'client' or 'lab';
        specification python:request.get('specification', default_spec);
        analyses python:here.getAnalyses();
        calc_cols python:view.get_calc_columns(analyses);
        any_tv python:'tv' in calc_cols;
        any_tf python:'tf' in calc_cols;
        any_vm python:'vm' in calc_cols;
        any_sm python:'sm' in calc_cols;
        any_nm python:'nm' in calc_cols;
        any_gm python:'gm' in calc_cols;
        view_worksheets python:member.has_role(('Manager', 'LabManager', 'LabClerk', 'LabTechnician'));
        attachments_allowed here/bika_settings/getAttachmentsPermitted;
        ar_attach_allowed here/bika_settings/getARAttachmentsPermitted;
        analysis_attach_allowed here/bika_settings/getAnalysisAttachmentsPermitted;
        colspan python:3;
        colspan python:view_worksheets and any_tv and (colspan + 1) or colspan;
        colspan python:view_worksheets and any_tf and (colspan + 1) or colspan;
        colspan python:view_worksheets and any_vm and (colspan + 1) or colspan;
        colspan python:view_worksheets and any_sm and (colspan + 1) or colspan;
        colspan python:view_worksheets and any_nm and (colspan + 1) or colspan;
        colspan python:view_worksheets and any_gm and (colspan + 1) or colspan;
        colspan python:view_worksheets and (colspan + 1) or colspan;
        colspan python:analysis_attach_allowed and (colspan + 1) or colspan;
        colspan python:dry_matter and (colspan + 1) or colspan;
        colspan1 python:colspan / 3;
        colspan2 python:(colspan - colspan1) / 2;
        colspan3 python:colspan - colspan1 - colspan2;
        colspan_all python:colspan + 1;
        ar_review_state python:context.portal_workflow.getInfoFor(here, 'review_state', '');
        now view/now;
        attachments here/getAttachment | nothing;
        delete_attachments python:False;
        update_attachments python:False">

  <h1>
      <img src="" tal:attributes="src string:${portal/absolute_url}/images/ar.png"/>
      <span tal:content="title_string | here/title_or_id" />
      <img src=""
          tal:condition="here/getInvoiceExclude"
          tal:attributes="src string:${portal/absolute_url}/images/no_invoice.png">
  </h1>

  <div tal:condition="attachments_allowed">
    <span i18n:translate="label_attachments">Attachments</span>:
    <metal:block use-macro="here/attachments/macros/ar_attachments_list"/>
  </div>

  <form id="analysisrequest_edit_form" name="analysisrequest_edit_form"  method="POST" enctype="multipart/form-data">

    <table width="100%">
      <tr>
        <td>
          <span i18n:translate="label_range_specification">Range Specification</span>:
          <input class="noborder" type="radio" name="specification" value="lab"
              onclick="this.form.submit()"
              tal:attributes="checked python: specification == 'lab' and 'checked' or None;"/>
          <label i18n:translate="label_lab_spec">Lab</label>
          <input class="noborder" type="radio" name="specification" value="client"
              onclick="this.form.submit()"
              tal:attributes="checked python: specification == 'client' and 'checked' or None;"/>
          <label i18n:translate="label_client_spec">Client</label>
        </td>
        <td align="right">
          <tal:hazardous tal:condition="sampletype/getHazardous">
            <img src="" tal:attributes="src string:${portal/absolute_url}/images/hazardous.png">
          </tal:hazardous>
        </td>
      </tr>
    </table>

    <table
        summary="Analysisrequest view"
        class="analysisrequest"
        cellpadding="0" cellspacing="0">

    <thead>

      <tr>
        <th i18n:translate="label_contact_person">Contact person</th>
        <td class="left" tal:attributes="colspan colspan">
          <a tal:define="contact here/getContact"
            tal:condition="nocall:contact"
            tal:attributes="href contact/absolute_url"
            tal:content="contact/Title">Pete Smith</a>
          <tal:ccs define="ccs here/getCCContact" condition="nocall:ccs" repeat="cc ccs">
            <span tal:condition="python:repeat['cc'].index == 0">&nbsp;cc:</span>
            <span tal:condition="python:repeat['cc'].index > 0">;</span>
            <a tal:content="cc/Title" tal:attributes="href cc/absolute_url"/>
          </tal:ccs>
        </td>
      </tr>
      <tr>
      <th i18n:translate="label_cc_emails">cc (email)
      </th>
      <td class="left"
          tal:attributes="colspan colspan"
          tal:content="here/getCCEmails">a@b.com</td>
      </tr>
      <tr>
        <th i18n:translate="label_client_order_id">Client Order ID</th>
        <td class="left"
            tal:attributes="colspan colspan1"
            tal:content="here/getClientOrderNumber|nothing">123</td>
        <th tal:attributes="colspan colspan2" i18n:translate="label_sampleid">Sample</th>
        <td class="left"
            tal:attributes="colspan colspan3">
          <a tal:attributes="href sample/absolute_url">
              <span tal:content="sample/Title">S-00001</span>
          </a>
        </td>
      </tr>
      <tr>
        <th i18n:translate="label_clientreference">Client Reference</th>
        <td class="left"
            tal:attributes="colspan colspan1"
            tal:content="sample/getClientReference">R001</td>
        <th tal:attributes="colspan colspan2"
            i18n:translate="label_clientsampleid">Client Sample ID
        </th>
        <td class="left"
            tal:attributes="colspan colspan3"
            tal:content="sample/getClientSampleID">S001</td>
      </tr>
      <tr>
        <th i18n:translate="label_sampletype">Sample type</th>
        <td class="left"
            tal:attributes="colspan colspan1"
            tal:content="sampletype/Title|nothing">sample type</td>
        <th tal:attributes="colspan colspan2"
            i18n:translate="label_samplepoint">Sample point
        </th>
        <td class="left"
            tal:attributes="colspan colspan3"
            tal:define="samplepoint sample/getSamplePoint"
            tal:content="samplepoint/Title|nothing">sample point</td>
      </tr>
      <tr>
        <th i18n:translate="label_status">Status
        </th>
        <td class="left"
            tal:attributes="colspan colspan1"
            tal:content="ar_review_state">received</td>
        <th tal:attributes="colspan colspan2" i18n:translate="label_arprofiles">Profile</th>
        <td class="left"
            tal:attributes="colspan colspan3"
            tal:content="profile">pr01</td>
      </tr>
      <tr>
        <th i18n:translate="label_datesampled">Date sampled</th>
        <td class="left" tal:attributes="colspan colspan1">
        <span
            tal:define="date_sampled sample/getDateSampled"
            tal:condition="date_sampled"
            tal:content="python:context.toLocalizedTime(date_sampled, long_format=1)"
            >2005-01-01</span>
        </td>
        <th tal:attributes="colspan colspan2" i18n:translate="label_daterequested">Date requested</th>
        <td tal:attributes="colspan colspan3" class="left">
        <span
            tal:define="date_requested here/getDateRequested"
            tal:condition="date_requested"
            tal:content="python:context.toLocalizedTime(date_requested, long_format=1)"
            >2005-01-01 10:00
        </span></td>
      </tr>
      <tr tal:condition="python:ar_review_state != 'sample_due'">
        <th i18n:translate="label_datereceived">Date received
        </th>
        <td class="left"
            tal:attributes="colspan colspan1"
            tal:define="date_received here/getDateReceived"
            tal:content="python:context.toLocalizedTime(date_received, long_format=1)"
            >2005-01-01 10:00</td>
        <th tal:attributes="colspan colspan2">
        <span tal:condition="python:ar_review_state in ('verified', 'published')"
            i18n:translate="label_verified_by">Verified by </span></th>
        <td class="left"
            tal:attributes="colspan colspan3">
        <span
            tal:condition="python:ar_review_state in ('verified', 'published')"
            tal:define="verifier python:view.get_analysisrequest_verifier(here)"
            tal:content="verifier"></span>
        </td>
      </tr>
      <tr tal:condition="python:ar_review_state == 'published'">
        <th i18n:translate="label_datepublished">Date published
        </th>
        <td class="left"
            tal:attributes="colspan colspan1"
            tal:define="date_published here/getDatePublished"
            tal:content="python:context.toLocalizedTime(date_published, long_format=1)"
            i18n:translate=""
            >2005-01-01 10:00</td>
        <th tal:attributes="colspan colspan2"></th>
        <td tal:attributes="colspan colspan3"></td>
      </tr>

    </thead>

    <tbody
      tal:define="cats view/Categories">

      <!-- -- -- Analyses -- -- -->

      <tal:pointofcapture repeat="poc python:cats.keys()">

        <tr class="PointOfCapture">
         <th tal:attributes="colspan colspan_all">
           <b tal:content="python:modules['bika.lims.config'].POINTS_OF_CAPTURE.getValue(str(poc))">Analyses</b>
         </th>
        </tr>

        <tr>
          <th i18n:translate="label_analysis">Analysis</th>
          <th i18n:translate="label_status">Status</th>
          <th i18n:translate="label_worksheet"
              tal:condition="python:view_worksheets">Worksheet</th>
          <tal:tv condition="python:any_tv and view_worksheets">
          <th i18n:translate="label_titrationvolume">Titration Volume</th>
          </tal:tv>
          <tal:tf condition="python:any_tf and view_worksheets">
          <th i18n:translate="label_titrationfactor">Titration Factor</th>
          </tal:tf>
          <tal:vm condition="python:any_vm and view_worksheets">
          <th i18n:translate="label_vesselmass">Vessel Mass</th>
          </tal:vm>
          <tal:gm condition="python:any_gm and view_worksheets">
          <th i18n:translate="label_grossmass">Gross Mass</th>
          </tal:gm>
          <tal:sm condition="python:any_sm and view_worksheets">
          <th i18n:translate="label_samplemass">Sample Mass</th>
          </tal:sm>
          <tal:nm condition="python:any_nm and view_worksheets">
          <th i18n:translate="label_netmass">Net Mass</th>
          </tal:nm>
          <tal:nodrymatter tal:condition="not:dry_matter">
          <th>
          <span i18n:translate="label_result">Result</span>
          </th>
          <th i18n:translate="label_variation">+/-</th>
          </tal:nodrymatter>
          <tal:drymatter tal:condition="dry_matter">
          <th i18n:translate="label_result_as_fed">Result As Fed </th>
          <th i18n:translate="label_variation">+/-</th>
          <th i18n:translate="label_result_dry">Result Dry </th>
          </tal:drymatter>
          <th tal:condition="analysis_attach_allowed"
              i18n:translate="label_attachments">attachments</th>
          <!--- for calendar testing
          <th i18n:translate="label_maxhours">Max</th>
          <th i18n:translate="label_duedate">Due</th>
          <th i18n:translate="label_duration">dur</th>
          <th i18n:translate="label_earliness">Early</th>
          -->
        </tr>

        <tal:categories define="analyses python:view.get_requested_analyses();"
                        repeat="cat python:cats[poc]">
            <tr>
              <th class="analysiscategory"
                tal:attributes="name python:cat[1]+'_'+poc;
                                id python:cat[1]+'_'+poc;
                                colspan colspan_all">
                <a tal:content="python:cat[0]">Category Title</a>
              </th>
            </tr>

      <tal:analyses repeat="analysis analyses">
        <tal:analysis define="service analysis/getService"
                      condition="python:service.getCategoryName() == cat[0]">
          <tr tal:define="
              service analysis/getService;
              result analysis/getResult;
              review_state python:here.portal_workflow.getInfoFor(analysis, 'review_state', '');
              analysis_late python:(review_state not in ['sample_due', 'published']) and (analysis.getDueDate() < now);
              may_view_result python:checkPermission('bika.lims: View Results', analysis)">

            <td class="left">
              <a  onClick="" title="Click for details"
                  tal:attributes="onClick string:javascript:showMethod('$portal_url', '${service/getId}')"
                  tal:content="analysis/Title">Alcohol</a>
              <img tal:condition="python:dry_matter and service.getReportDryMatter()"
                   src="" tal:attributes="src string:${portal/absolute_url}/images/dry.png">
              <img tal:condition="python:lab_accredited and service.getAccredited()"
                   src="" tal:attributes="src string:${portal/absolute_url}/images/accredited.png">
              <tal:late tal:condition="analysis_late">
                <img tal:define="global late python:1"
                   src="" tal:attributes="src string:${portal/absolute_url}/images/late_small.png">
              </tal:late>
            </td>
            <td>

      <a  href="" title="Click for analysis history"
          tal:define="log_href string:${analysis/absolute_url}/images/analysis_status_log"
          tal:attributes="href log_href"
          tal:content="review_state"
          i18n:translate="">
      Sample due</a>

      </td>
      <td tal:condition="python:view_worksheets">
      <a tal:define="worksheet analysis/getWorksheet|nothing"
         tal:condition="nocall:worksheet"
         tal:attributes="href worksheet/absolute_url"
         tal:content="worksheet/Title">worksheet</a>
      </td>
      <tal:tv condition="python:any_tv and view_worksheets">
      <td tal:define="titration_vol analysis/getTitrationVolume|nothing;
                      titration_unit service/getTitrationUnit|nothing">
      <span tal:condition="titration_vol"
         tal:content="string:$titration_vol $titration_unit">10 ml</span>
      </td>
      </tal:tv>
      <tal:tf condition="python:any_tf and view_worksheets">
      <td tal:content="analysis/getTitrationFactor">10</td>
      </tal:tf>
      <tal:vm condition="python:any_vm and view_worksheets">
      <td tal:content="analysis/getVesselMass">10</td>
      </tal:vm>
      <tal:gm condition="python:any_gm and view_worksheets">
      <td tal:content="analysis/getGrossMass">10</td>
      </tal:gm>
      <tal:sm condition="python:any_sm and view_worksheets">
      <td tal:content="analysis/getSampleMass">10</td>
      </tal:sm>
      <tal:nm condition="python:any_nm and view_worksheets">
      <td tal:content="analysis/getNetMass">10</td>
      </tal:nm>
      <div:result
          tal:define="
              result_class python:view.result_in_range(analysis, sampletype_uid, specification);
              global out_of_range python:result_class == 'out_of_range' and 1 or out_of_range">

      <td tal:condition="may_view_result"
          tal:attributes="class result_class" style="white-space: nowrap;">
      <tal:result tal:condition="result">
      <span tal:content="result">10</span>
      <img tal:condition="python:result_class == 'out_of_range'"
          src="" tal:attributes="src string:${portal/absolute_url}/images/exclamation.png">
      <div class="reed"
            tal:condition="analysis/getRetested"
            i18n:translate="retested">retested</div>
      </tal:result>
      <span class="unit" tal:content="analysis/getUnit">%vol</span>
      </td>

      <td tal:condition="python:not may_view_result">
      <img src=""
          tal:define="global tf python:1"
          tal:attributes="src string:${portal/absolute_url}/images/to_follow.png">
      </td>

      </div:result>
      <td>
      <span
          tal:condition="python:result and may_view_result"
          tal:content="analysis/getUncertainty">0.8</span>
      </td>

      <td tal:condition="dry_matter" style="white-space: nowrap;">
      <tal:service_dry tal:condition="service/getReportDryMatter">

      <tal:showdry tal:condition="may_view_result">
      <span tal:condition="analysis/getResultDM"
            tal:content="analysis/getResultDM">10</span>
      <span class="unit" tal:content="analysis/getUnit">%vol</span>
      </tal:showdry>

      <tal:notyet tal:condition="python:not may_view_result">
      <img src=""
          tal:define="global tf python:1"
          tal:attributes="src string:${portal/absolute_url}/images/to_follow.png">
      </tal:notyet>
      </tal:service_dry>
      </td>

      <td tal:condition="analysis_attach_allowed" class="left">
      <div tal:condition="python:not service.getAttachmentOption() == 'n'">
      <tal:attachments
          tal:define="attachments analysis/getAttachment | nothing">
      <metal:block use-macro="here/attachments/macros/analysis_attachments_list"/>
      </tal:attachments>
      </div>
      </td>
      <!-- for calendar testing
      <td tal:content="analysis/getMaxHoursAllowed"></td>
      <td>
      <span tal:define="due_date analysis/getDueDate|nothing"
          tal:condition="due_date"
          tal:content="python:context.toLocalizedTime(due_date, long_format=1)"
          >2005-01-01 10:00</span>
      </td>
      <td tal:content="analysis/getDuration | nothing"></td>
      <td tal:content="analysis/getEarliness| nothing"></td>
      -->

      </tr>
      </tal:analysis>
        </tal:analyses>
            </tal:categories>

          </tal:pointofcapture>

        </tbody>

    </table>

    <div class="field">
      <label i18n:translate="label_remarks">Notes:</label>
      <p class="comment" tal:content="python:here.getNotes() or default">None</p>
    </div>

    <hr class="discreet"/>

    <div class="discreeter"
         tal:define="global seq_no python:0">
      <p tal:condition="out_of_range">
        <img src="" tal:attributes="src string:${portal/absolute_url}/images/exclamation.png">
        <span i18n:translate="legend_out_of_rangex">
          Result out of <tal:block replace="specification" i18n:name="spec"/> specified range
        </span>
      </p>
      <p tal:condition="late">
        <img src="" tal:attributes="src string:${portal/absolute_url}/images/late_small.png">
        <span i18n:translate="legend_late">Late analysis</span>
      </p>
      <p tal:condition="dry_matter">
        <img src="" tal:attributes="src string:${portal/absolute_url}/images/dry.png">
        <span i18n:translate="disclaimer_dry">Reported as dry matter</span>
      </p>
      <p tal:condition="tf">
        <img src="" tal:attributes="src string:${portal/absolute_url}/images/to_follow.png">
        <span i18n:translate="description_tofollow">Results to follow</span>
      </p>
      <p tal:condition="here/getInvoiceExclude">
        <img src="" tal:attributes="src string:${portal/absolute_url}/images/no_invoice.png">
        <span i18n:translate="disclaimer_invoice_exclude">Not invoiced</span>
      </p>
      <p tal:condition="lab_accredited">
      <img src="" tal:attributes="src string:${portal/absolute_url}/images/accredited.png">
      <span i18n:translate="disclaimer_accred">
        Methods included in the <tal:block replace="here/bika_settings/laboratory/AccreditationBody" i18n:name="accreditation_body"/> schedule of Accreditation for this Laboratory. Analysis remarks are not accredited</span>
      </p>
      <p>
        <span tal:define="global seq_no python:seq_no + 1"
              tal:content="string:$seq_no.">1</span>
        <span i18n:translate="disclaimer_results_samples_tested">
          Analysis results relate only to the samples tested
        </span>
      </p>
      <p tal:define="confidence_level here/bika_settings/laboratory/Confidence|nothing"
         tal:condition="confidence_level">
        <span tal:define="global seq_no python:seq_no + 1"
              tal:content="string:$seq_no.">1</span>
        <span i18n:translate="disclaimer_confidence_level">
          Test results are at a <tal:block replace="confidence_level" i18n:name="lab_confidence"/>% confidence level
        </span>
      </p>
      <p>
        <span tal:define="global seq_no python:seq_no + 1"
              tal:content="string:$seq_no.">1</span>
        <span i18n:translate="disclaimer_no_reproduce">
          This document shall not be reproduced except in full, without the written approval of <tal:block replace="here/bika_settings/laboratory/Title" i18n:name="name_lab"/>
        </span>
      </p>
      <div tal:condition="python:ar_review_state in ('verified', 'published')">
        <span i18n:translate="disclaimer_questions">
          If you have any questions regarding this analysis please contact your analyst
        </span>
        <br/>
        <span i18n:translate="label_responsible">Manager: </span>
        <tal:details tal:repeat="manager mngr_ids"
            tal:define="mngr_info python:here.getResponsible();
                        mngr_ids python:mngr_info['ids'];
                        managers python:mngr_info['dict']">
          <tal:mngr
               tal:define="email python:managers[manager]['email'];
                          phone python:managers[manager]['phone']">
            <span tal:content="python:managers[manager]['name']">Joe Blogs</span>
            <span tal:condition="phone">&nbsp&nbsp</span>
            <img src=""
                tal:condition="phone"
                tal:attributes="src string:${portal/absolute_url}/telephone.jpg">
            <span tal:content="phone">011 555 1112</span>
            <span tal:condition="email">&nbsp&nbsp</span>
            <a tal:attributes="href string:mailto:${email}"
               tal:content="email">a@b.com</a>
          </tal:mngr>
        </tal:details>
      </div>
    </div>

  </form>

</div>
</body>
</html>
