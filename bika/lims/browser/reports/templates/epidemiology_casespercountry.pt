<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:tal="http://xml.zope.org/namespaces/tal"
	xmlns:metal="http://xml.zope.org/namespaces/metal"
	xmlns:i18n="http://xml.zope.org/namespaces/i18n"
	i18n:domain="bika"
	tal:define="portal_url nocall:context/portal_url;
				portal portal_url/getPortalObject;">
	
	<head>
		<link rel="stylesheet" type="text/css" media="all" href=""
	    	tal:attributes="href string:$portal_url/reports.css" />
	</head>

	<body tal:define="
		report_data view/report_data;
        parameters python:report_data.has_key('parameters') and report_data['parameters'] or [];
        datalines python:report_data.has_key('datalines') and report_data['datalines'] or {};
        batches python:report_data.has_key('batches') and report_data['batches'] or {};
        totalnum python:0;">
        
        <!--
        
        Report customization notes
        ==========================================================================
        Available attributes:
        	
       	parameters[]
       	
       	batches {
       		<batch>: {
       			BatchID,
       			ClientBatchID,
       			DateCreated,
       			OnsetDate,
       			PatientAge,
       			PatientGender,
       			PatientCountry,       			
       			NumAnalyses,
       			Analyses {
       				<analysis> : {
       					Keyword,
       					AnalysisRequest,
       					ServiceTitle,
       					Result       					
       				}
       			}
       		}
       	}
       	
       	datalines {
       		<group>: { 
       			 Group,
       			 Countries {
	       			 <country>: {
	       			 	Country,
	       			 	Batches [
	       			 		BatchID
	       			 	]	       			 
	       			 }
       			 }       			      			 	
   			}
   		}
     			
   		From batches:
   		- dict key <batch> is the BatchID
   		- dict key <analysis> is the AnalysisRequest ID + "." + Analysis Keyword
   		- BatchID: the Lab ID for the batch/case
   		- ClientBatchID: the Client ID for the batch/case
   		- DateCreated: creation date of the batch/case
   		- OnsetDate: Batch/Case onset date
   		- PatientAge: Batch/Case's patient age when onset date
   		- PatientGender: Batch/Case's patient gender
   		- PatientCountry: Batch/Case's patient country
   		- NumAnalyses: Number of analyses per Batch/Case
   		- Analysis.Keyword: Analysis Keyword
   		- Analysis.AnalysisRequest: AnalysisRequest ID
   		- Analysis.ServiceTitle: Analysis Service title
   		- Analysis.Result: Analysis result
   		
		From datalines:
   		- dict key <group> is the period grouping name (year, monthyear, yearweek)
   		- dict key <country> is the Country name
		- Group: The period grouping name
		

       	footlines {
       		Total: {
       			Requested,    	-- total requested analyses count
       			Published,		-- total published analyses count
       			PerformedRequestedRatio,
       			PerformedRequestedRatioPercentage,
       			PublishedPerformedRatio,	
       			PublishedPerformedRatioPercentage
       		}
       	}
        
        -->
        
		<h2 i18n:translate="">Cases summary per country</h2>
		<h3 i18n:translate="">Lists all cases for a date range grouped by countries</h3>
			
		<!-- Summary -->
		<table class="bika-report-parms" summary="Parameters">
			<tr tal:repeat="line parameters">
				<td tal:content="python:line['title']"></td>
				<td tal:content="python:line['value']"></td>
			</tr>
		</table>
		
		<!-- Results -->	
		<metal:block tal:repeat="period python:datalines.keys()">
			<h4 tal:content="period" 
				tal:condition="python:len(period)>0"
				tal:define="global numperiod python:0;">
			</h4>
			
			<metal:block tal:repeat="country python:datalines[period]['Countries'].keys()">
				<h4 tal:content="country" 
					tal:define="global numcountry python:0;"
					tal:condition="python:len(period)==0">
				</h4>	
				<h5 tal:content="country" 
					tal:define="global numcountry python:0;"
					tal:condition="python:len(period)>0">
				</h5>
				<table class="bika-report-table" summary="Cases">
					<thead>
						<tr>
							<th i18n:translate="">Case ID</th>					
							<th i18n:translate="">Hospital's Case ID</th>
							<th i18n:translate="">Onset Date</th>
							<th>						
								<span i18n:translate="">Patient Age (years)</span>
								<span style="font-size:0.6em;vertical-align:super;">1</span>
							</th>
							<th i18n:translate="">Patient Gender</th>
						</tr>
					</thead>
					<tbody>
						<metal:block tal:repeat="batchid python:datalines[period]['Countries'][country]['Batches']">
						<tr tal:define="global numcountry python:numcountry+1;
										global numperiod python:numperiod+1;
										global totalnum python:totalnum+1;">
							<td tal:content="python:batches[batchid]['BatchID']"></td>
							<td tal:content="python:batches[batchid]['ClientBatchID']"></td>	
							<td tal:content="python:batches[batchid]['OnsetDate']"></td>
							<td tal:content="python:batches[batchid]['PatientAge']"></td>					
							<td tal:content="python:batches[batchid]['PatientGender']"></td>
						</tr>		
						<tr tal:condition="python:len(batches[batchid]['Analyses'])>0">
							<td colspan="1" style="border-bottom:none;">&nbsp;</td>
							<td colspan="4" style="padding-top:5px;padding-bottom:5px;border-bottom:none;">
								<table class="bika-report-table" style="font-size:11px;" summary="Results">
									<thead>
										<tr>
											<th i18n:translate="">Analysis Request ID</th>
											<th i18n:translate="">Keyword</th>
											<th i18n:translate="">Analysis</th>
											<th i18n:translate="">Result</th>				
										</tr>
									</thead>
									<tbody>
										<metal:block tal:repeat="ankey python:batches[batchid]['Analyses'].keys()">
										<tr>
											<td tal:content="python:batches[batchid]['Analyses'][ankey]['AnalysisRequest']"></td>
											<td tal:content="python:batches[batchid]['Analyses'][ankey]['Keyword']"></td>
											<td width="100%" tal:content="python:batches[batchid]['Analyses'][ankey]['ServiceTitle']"></td>
											<td tal:content="python:batches[batchid]['Analyses'][ankey]['Result']"></td>
										</tr>
										</metal:block> <!-- End Period/Country/Batch/Analysis Group -->
									</tbody>
								</table>
							</td>
						</tr>	
						</metal:block> <!-- End Period/Country/Batch Group -->	
					</tbody>
					<tfoot>
						<tr>
							<td class='total_label' i18n:translate="" style="border-bottom:none;" colspan="5">								
								<span i18n:translate="">Cases</span>&nbsp;
								(<span tal:content='python:country'></span>)&nbsp;&nbsp;
								<span class='total_label' tal:content="python:numcountry"></span>
							</td>
						</tr>
					</tfoot>
				</table>
			</metal:block>		
			<div tal:condition="python:len(period)>0">
				<span class='total_label' i18n:translate="">Cases</span>&nbsp;
				(<span class='total_label' tal:content="python:period"></span>):&nbsp;&nbsp;
				<span class='total_label' tal:content="python:numperiod"></span>
			</div>	
		</metal:block>
		<div style="margin-top:20px;border-tpop:1px solid #DCDCDC;">
			<span class='total_label' i18n:translate="">Total Cases</span>:&nbsp;&nbsp;
			<span class='total_label' tal:content="python:totalnum"></span>
		</div>		
		<div style="margin-top:20px;border-tpop:1px solid #DCDCDC;font-size:0.7em;">
			<ul style='list-style-type: none;padding-left: 0px;margin-left:0px;padding-top:0px;'>
				<li>
					<span style="vertical-align:super;font-size:0.7em">1</span>&nbsp;&nbsp;
					<span i18n:translate="">Patient's age when case's onset date</span>
				</li>
			</ul>
		</div>
	</body>
</html>