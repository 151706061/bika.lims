<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:tal="http://xml.zope.org/namespaces/tal"
	xmlns:metal="http://xml.zope.org/namespaces/metal"
	xmlns:i18n="http://xml.zope.org/namespaces/i18n"
	i18n:domain="bika"
	tal:define="portal_url nocall:context/portal_url;
				portal portal_url/getPortalObject;">
	
	<head>
		<link rel="stylesheet" type="text/css" media="all" href=""
	    	tal:attributes="href string:$portal_url/reports.css" />
	</head>

	<body tal:define="
		report_data view/report_data;
        parameters python:report_data.has_key('parameters') and report_data['parameters'] or [];
        datalines python:report_data.has_key('datalines') and report_data['datalines'] or {};
        batches python:report_data.has_key('batches') and report_data['batches'] or {}">
        
        <!--
        
        Report customization notes
        ==========================================================================
        Available attributes:
        	
       	parameters[]
       	
       	batches {
       		<batch>: {
       			BatchID,
       			ClientBatchID,
       			DateCreated,
       			OnsetDate,
       			PatientAge,
       			PatientGender,
       			PatientCountry,       			
       			NumAnalyses,
       			Analyses {
       				<analysis> : {
       					Keyword,
       					AnalysisRequest,
       					ServiceTitle,
       					Result       					
       				}
       			}
       		}
       	}
       	
       	datalines {
       		<group>: { 
       			 Group,
       			 Countries {
	       			 <country>: {
	       			 	Country,
	       			 	Batches [
	       			 		BatchID
	       			 	]	       			 
	       			 }
       			 }       			      			 	
   			}
   		}
     			
   		From batches:
   		- dict key <batch> is the BatchID
   		- dict key <analysis> is the AnalysisRequest ID + "." + Analysis Keyword
   		- BatchID: the Lab ID for the batch/case
   		- ClientBatchID: the Client ID for the batch/case
   		- DateCreated: creation date of the batch/case
   		- OnsetDate: Batch/Case onset date
   		- PatientAge: Batch/Case's patient age when onset date
   		- PatientGender: Batch/Case's patient gender
   		- PatientCountry: Batch/Case's patient country
   		- NumAnalyses: Number of analyses per Batch/Case
   		- Analysis.Keyword: Analysis Keyword
   		- Analysis.AnalysisRequest: AnalysisRequest ID
   		- Analysis.ServiceTitle: Analysis Service title
   		- Analysis.Result: Analysis result
   		
		From datalines:
   		- dict key <group> is the period grouping name (year, monthyear, yearweek)
   		- dict key <country> is the Country name
		- Group: The period grouping name
		

       	footlines {
       		Total: {
       			Requested,    	-- total requested analyses count
       			Published,		-- total published analyses count
       			PerformedRequestedRatio,
       			PerformedRequestedRatioPercentage,
       			PublishedPerformedRatio,	
       			PublishedPerformedRatioPercentage
       		}
       	}
        
        -->
        
		<h2 i18n:translate="">Cases summary per country</h2>
		<h3 i18n:translate="">Lists all cases for a date range grouped by countries</h3>
			
		<!-- Summary -->
		<table class="bika-report-parms" summary="Parameters">
			<tr tal:repeat="line parameters">
				<td tal:content="python:line['title']"></td>
				<td tal:content="python:line['value']"></td>
			</tr>
		</table>
		
		<!-- Results -->		
		<table class="bika-report-table" summary="Cases">
			<thead>
				<tr>
					<th i18n:translate="">Period</th>
					<th i18n:translate="">Country</th>
					<th i18n:translate="">Case ID</th>					
					<th i18n:translate="">Hospital's Case ID</th>
					<th i18n:translate="">Onset Date</th>
					<th>						
						<span i18n:translate="">Patient Age (years)</span>
						<span style="font-size:0.6em;vertical-align:super;">1</span>
					</th>
					<th i18n:translate="">Patient Gender</th>
				</tr>
			</thead>
			<tbody tal:define="global totalnumcases python:0;">
				<metal:block tal:repeat="key python:datalines.keys()">
				<tr tal:define="global periodnumcases python:0;">
					<td tal:content="key" colspan="7"></td>
				</tr>
				
				<metal:block tal:repeat="country python:datalines[key]['Countries'].keys()">
				<tr tal:define="global totalnumcases python:+len(datalines[key]['Countries'][country]['Batches']);">
					<td style="border-bottom:none;">&nbsp;</td>
					<td tal:content="country" colspan="6"></td>
				</tr>
				
				<metal:block tal:repeat="batchid python:datalines[key]['Countries'][country]['Batches']">
				<tr tal:define="global periodnumcases python:+1;">
					<td colspan="2" style="border-bottom:none;">&nbsp;</td>
					<td tal:content="python:batches[batchid]['BatchID']" style="padding-top:5px"></td>
					<td tal:content="python:batches[batchid]['ClientBatchID']" style="padding-top:5px"></td>	
					<td tal:content="python:batches[batchid]['OnsetDate']" style="padding-top:5px"></td>
					<td tal:content="python:batches[batchid]['PatientAge']" style="padding-top:5px"></td>					
					<td tal:content="python:batches[batchid]['PatientGender']" style="padding-top:5px"></td>
				</tr>		
				<tr tal:condition="python:len(batches[batchid]['Analyses'])>0">
					<td colspan="3" style="border-bottom:none;">&nbsp;</td>
					<td colspan="4" style="padding-top:5px;padding-bottom:5px;border-bottom:none;">
						<table class="bika-report-table" style="font-size:11px;" summary="Results">
							<thead>
								<tr>
									<th i18n:translate="">Analysis Request ID</th>
									<th i18n:translate="">Keyword</th>
									<th i18n:translate="">Analysis</th>
									<th i18n:translate="">Result</th>				
								</tr>
							</thead>
							<tbody>
								<metal:block tal:repeat="ankey python:batches[batchid]['Analyses'].keys()">
								<tr>
									<td tal:content="python:batches[batchid]['Analyses'][ankey]['AnalysisRequest']"></td>
									<td tal:content="python:batches[batchid]['Analyses'][ankey]['Keyword']"></td>
									<td tal:content="python:batches[batchid]['Analyses'][ankey]['ServiceTitle']"></td>
									<td tal:content="python:batches[batchid]['Analyses'][ankey]['Result']"></td>
								</tr>
								</metal:block> <!-- End Period/Country/Batch/Analysis Group -->
							</tbody>
						</table>
					</td>
				</tr>	
				</metal:block> <!-- End Period/Country/Batch Group -->
				<tr>
					<td style="border-bottom:none;">&nbsp;</td>
					<td class='total_label' i18n:translate="" align="right" style="border-bottom:none;">Num of Cases</td>
					<td colspan="5" tal:content="python:len(datalines[key]['Countries'][country]['Batches'])"></td>
				</tr>	
				</metal:block> <!-- End Period/Country Group -->
				<tr>
					<td class='total_label' i18n:translate="" align="right" style="border-bottom:none;">Num of Cases</td>
					<td colspan="6" tal:content="python:periodnumcases"></td>
				</tr>
				<tr>
					<td class='total_label' i18n:translate="" align="right" style="border-bottom:none;">Num of Countries</td>
					<td colspan="6" tal:content="python:len(datalines[key]['Countries'])"></td>
				</tr>
				</metal:block> <!-- End Period Group -->
			</tbody>
			<tfoot>
				<tr>
					<td class='total_label' i18n:translate="" align="right" style="padding-top:15px;border-bottom:none;">Total Num of Cases</td>
					<td tal:content="python:totalnumcases" colspan="6" style="padding-top:15px;"></td>
				</tr>
			</tfoot>			
		</table>
		<div style="margin-top:20px;border-tpop:1px solid #DCDCDC;font-size:0.7em;">
			<ul style='list-style-type: none;padding-left: 0px;margin-left:0px;padding-top:0px;'>
				<li>
					<span style="vertical-align:super;font-size:0.7em">1</span>&nbsp;&nbsp;
					<span i18n:translate="">Patient's age when case's onset date</span>
				</li>
			</ul>
		</div>
	</body>
</html>