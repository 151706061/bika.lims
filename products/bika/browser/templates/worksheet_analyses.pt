<html
    xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
    i18n:domain="bika"
    metal:use-macro="here/main_template/macros/master">

<head> </head>

<body>

<div metal:fill-slot="main"
    tal:define="

        orientation python:request.get('orientation', 'horizontal');
        b_size python:orientation == 'vertical' and 6 or 30;
        b_start python:0;
        b_start request/b_start | b_start;
        Batch python:modules['Products.CMFPlone'].Batch;
        analyses python:view.sort_analyses_on_requestid(here.getAnalyses());
        result_set python:(orientation == 'vertical' and view.group_analyses_by_request(analyses) or view.group_analyses_for_worksheet());
        results python:(orientation == 'vertical' and result_set or result_set['results']);
        review_state context/getWorkflowState;
        open_ws python:review_state == 'open';
        cols result_set/any_cols;
        any_tv python:'tv' in cols;
        any_tf python:'tf' in cols;
        any_gm python:'gm' in cols;
        any_sm python:'sm' in cols;
        any_nm python:'nm' in cols;
        any_vm python:'vm' in cols;
        global any_published result_set/published;
        global out_of_range python:0;
        global dry_matter python:0;
        global late python:0;
        now view/now;
        batch python:Batch(results, b_size, int(b_start), orphan=1);
        specification python:request.get('specification', 'lab');
        uid context/getAnalyser;
        attach_analyses python:[a for a in analyses if context.portal_workflow.getInfoFor(a, 'review_state', '') in ['assigned', 'to_be_verified']];
        attach_services python:[a.getService() for a in attach_analyses if a.getService().getAttachmentOption() in ['p', 'r']];
        attach_analyses python:[a for a in attach_analyses if a.getService() in attach_services];
        sort_on python:(('Title', 'nocase', 'asc'),);
        attach_services python:view.sequence.sort(attach_services, sort_on);
        analysis_attach_allowed here/bika_settings/getAnalysisAttachmentsPermitted;
        update_attachments python:True">

<script type="text/javascript" src="calcs.js"></script>
<script type="text/javascript" src="utils.js"></script>

<h1 tal:content="here/title_or_id"/>

<tal:links
    tal:define="linkedws here/getLinkedWorksheet |nothing"
    tal:condition="nocall:linkedws">
(
<span i18n:translate="message_linked_worksheets">linked to:</span>
<tal:ws
    tal:repeat="ws linkedws">
<a href=""
    tal:content="ws/Number"
    tal:attributes="href ws/absolute_url">WS-0002</a>
</tal:ws>
)
<br>
</tal:links>

<div tal:condition="python:analysis_attach_allowed and attach_services">
<metal:block use-macro="here/attachments/macros/ws_attachments"/>
</div>

<form name="folderContentsForm"
    method="post">
<div tal:condition="not: batch">
<span i18n:translate="worksheet_no_analysis_selected">
This worksheet contains no analyses</span>
</div>
<br>
<div>
<tal:buttons tal:condition="python:review_state =='open'">
<input
    class="standalone"
    type="submit"
    name="searchAnalyses:method"
    value="Add Analysis"
    tabindex=""
    tal:condition="batch"
    i18n:attributes="value"
    tal:attributes="tabindex tabindex/next|nothing" />
&nbsp
<input
    class="standalone"
    type="submit"
    name="addBlankAnalysis:method"
    value="Add Blank"
    tabindex=""
    i18n:attributes="value"
    tal:attributes="tabindex tabindex/next|nothing" />
&nbsp
<input
    class="standalone"
    type="submit"
    name="addControlAnalysis:method"
    value="Add Control"
    tabindex=""
    i18n:attributes="value"
    tal:attributes="tabindex tabindex/next|nothing" />
&nbsp
<input
    class="standalone"
    type="submit"
    name="addDuplicateAnalysis:method"
    value="Add Duplicate"
    tabindex=""
    tal:condition="analyses"
    i18n:attributes="value"
    tal:attributes="tabindex tabindex/next|nothing" />
&nbsp
<input
    class="standalone"
    type="submit"
    name="resequenceWorksheet:method"
    value="Resequence"
    tabindex=""
    tal:condition="batch"
    i18n:attributes="value"
    tal:attributes="tabindex tabindex/next|nothing" />
&nbsp
<input
    class="standalone"
    type="submit"
    name="instrument_export:method"
    value="Export"
    tabindex=""
    tal:condition="batch"
    i18n:attributes="value"
    tal:attributes="tabindex tabindex/next|nothing" />
</tal:buttons>
&nbsp
</div>
<div tal:condition="not: batch">

<div tal:content="structure view/worksheet_search"/>

</div>

<div tal:condition="batch" class="toggleOption">
<table width="100%">
<tr>
<td>

</td>
<td class="right"
    tal:condition="python:any_tv and open_ws">
<span i18n:translate="label_copy_titrations">Copy titration factors</span>: 
<input type="checkbox" class="noborder" name="copyTitrations" id="copyTF"
    tal:attributes="tabindex tabindex/next">
</td>
</tr>
<tr tal:condition="not:open_ws">
<td>
<span i18n:translate="label_range_specification">Range Specification</span>: 
<input class="noborder" type="radio" name="specification" value="lab"
    onclick="this.form.submit()"
    tal:attributes="
        checked python:test(specification == 'lab',  'checked', None);
        tabindex tabindex/next"/>
<label i18n:translate="label_lab_spec"
    >Lab</label>
<input class="noborder" type="radio" name="specification" value="client"
    onclick="this.form.submit()"
    tal:attributes="
        checked python:test(specification == 'client',  'checked', None);
        tabindex tabindex/next"/>
<label i18n:translate="label_client_spec"
    >Client</label>
</td>
</tr>
<tr>
<td>
<span i18n:translate="label_analysed_by">Analysed by:</span>
<span class='left'
    tal:condition="open_ws">
    <select name="analyser" 
        tal:attributes="tabindex tabindex/next;">
    <tal:item 
        tal:define="
            vocab here/getAnalysersDisplayList"
        tal:repeat="item vocab">
    <option selected="selected"
        tal:define="no_ref python:item == '';"
        tal:attributes="value item;
            selected python:test((item == uid) or no_ref, 'selected', '')"
        tal:content="python:here.translate(vocab.getMsgId(item), default=vocab.getValue(item))">
</option>
    </tal:item>
    </select>
</span>
<span class='left'
    tal:condition="not: open_ws"
    tal:content="here/getAnalyserName">
</span>
</td>
<td>
<table class="discreet"> <tr>
<td>
<img src="blank.png"/>
<span i18n:translate="label_blank">Blank</span></td>
<td>
<img src="control.png"/>
<span i18n:translate="label_control">Control</span></td>
<td>
<img src="dup.png"/>
<span i18n:translate="label_duplicate">Duplicate</span></td>
</tr>
</table>
</td>
</tr>
</table>
</div>


<div tal:condition="python:orientation == 'vertical'" 
     tal:content="structure view/worksheet_analyses_columns"/>

<div tal:condition="python:orientation == 'horizontal'"
     tal:content="structure view/worksheet_analyses_rows"/>


<br/>

<tal:buttons tal:repeat="button actions/folder_buttons|nothing">
<tal:block condition="batch">
<input
    class="context"
    type="submit"
    name=""
    value=""
    tabindex=""
    tal:condition="python:orientation=='vertical' and button['id'] in ('submit_results')"
    i18n:attributes="value"
    tal:attributes="
        value button/name;
        name button/url;
        tabindex tabindex/next" />
<input
    class="context"
    type="submit"
    name=""
    value=""
    tabindex=""
    tal:condition="python:orientation=='horizontal' and button['id'] in ('delete_analyses', 'submit_results')"
    i18n:attributes="value"
    tal:attributes="
        value button/name;
        name button/url;
        tabindex tabindex/next" />
</tal:block>
</tal:buttons>


<!-- Navigation -->
<div metal:use-macro="here/batch_macros/macros/navigation" />
<br>
<br>
<div class="discreeter"
    tal:define="global seq_no python:0">
<p tal:condition="out_of_range">
<img src="" tal:attributes="src string:${portal/absolute_url}/exclamation.png">
<span i18n:translate="legend_out_of_rangex">
Result out of <tal:block replace="specification" i18n:name="spec"/> specified range
</span>
</p>
<p tal:condition="late">
<img src="" tal:attributes="src string:${portal/absolute_url}/late_small.png">
<span i18n:translate="legend_late">Late analysis</span>
</p>
<p tal:condition="dry_matter">
<img src="" tal:attributes="src string:${portal/absolute_url}/dry_header.png">
<span i18n:translate="disclaimer_dry">
Reported as dry matter. Values in brackets denote results on a 'Dry Matter' basis</span>
</p>
</div>

</form>

</div>


</body>
</html>

