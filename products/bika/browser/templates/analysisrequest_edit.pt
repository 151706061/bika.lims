<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

  <head>
    <metal:block fill-slot="top_slot">
      <style type="text/css">
        #plone-contentmenu-workflow {display:inline;}
      </style>
    </metal:block>
  </head>

<body>

  <div metal:fill-slot="main" 
    tal:define="portal context/@@plone_portal_state/portal;
                plone_view context/@@plone;
                tabindex view/tabindex;
                edit python:view.came_from == 'edit' and True or False;
                review_state python:edit and context.portal_workflow.getInfoFor(view.context, 'review_state') or ''">

    <h1 i18n:translate="heading_request_new_analyses" tal:condition="python:not edit">Request new analyses</h1>
    <h1 tal:content="here/title_or_id" tal:condition="edit"/>

    <form id="analysisrequest_edit_form" 
          name="analysisrequest_edit_form" 
          method="POST">

      <input type="hidden" name="submitted" value="1" />
      <input type="hidden" name="came_from" tal:attributes="value view/came_from" />
      <input tal:replace="structure context/@@authenticator/authenticator" />

      <!-- member discount percentage if applicable -->
      <input type="hidden" id="member_discount" name="member_discount"
             tal:attributes="value here/bika_settings/getMemberDiscount"
             tal:condition="here/getMemberDiscountApplies"/> 

      <!-- col_count goes here for the jquery expanding services rows to know how to print themselves -->
      <input type="hidden" id="col_count" name="col_count" 
             tal:attributes="value view/col_count" />

      <!-- jquery dialogs -->
      <div id="confirm_add_deps" style="display:none" title="Service dependencies">
        This selection requires additional services.<br/>
        Do you want to select them now?
      </div>
      <div id="confirm_remove_antes" style="display:none" title="Service dependencies">
        Other selections depend on this service.<br/>
        Do you want these also to be unselected now?
      </div>

      <table cellpadding="0" cellspacing="0" class="analysisrequest">
        <thead>
          <!-- Contact -->
          <tr>
            <th colspan="2" class="rowheader">
              <span i18n:translate="label_contact_person">Contact person</span>
              &nbsp;<span class="fieldRequired"/>
            </th>
            <td>&nbsp;</td>
            <td class="contact"
                tal:attributes="colspan view/col_count;tabindex tabindex/next;"
                tal:define="this_contact python:edit and context.getContactUID();">
              <select name="Contact" id="contact">
                <tal:item 
                  tal:define="vocab here/getContactsDisplayList"
                  tal:repeat="item vocab">
                  <option 
                    tal:attributes="
                      value item;
                      selected python: item in (this_contact, ) and 'selected' or '';"
                    tal:content="python:here.translate(vocab.getValue(item), default=vocab.getValue(item))">
                  </option>
                </tal:item>
              </select>
              <!-- Contact CCs-->
              <input type="button" 
                id="open_cc_browser"
                value="cc" 
                i18n:attributes="value" 
                i18n:domain="bika"
                tal:attributes="tabindex tabindex/next;"/>
              <input DISABLED class="noborder" value="" id="cc_titles"
                tal:attributes="value python:edit and ','.join([c.Title() for c in context.getCCContact()])"/>
              <input type="hidden" id="cc_uids" name="cc_uids"
                tal:attributes="value python:edit and ','.join([c.UID() for c in context.getCCContact()])"/>
            </td>
          </tr>
          <!-- CC Emails -->
          <tr>
            <th colspan="2" i18n:translate="label_cc_email">cc emails</th>
            <td>&nbsp;</td>
            <td class="contact" tal:attributes="colspan view/col_count">
              <input style="width:98%" type="text" id="cc_emails" name="CCEmails" 
                tal:attributes="value python:hasattr(context, 'CCEmails') and context.CCEmails or '';
                                tabindex tabindex/next;"/>
            </td>
          </tr>
          <!-- AR Profile -->
          <tr tal:define="field_name string:ARProfile">
            <th colspan="2" i18n:translate="label_arprofiles">Profile</th>
            <td>&nbsp;</td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <select tal:attributes="class field_name;id input_id; name input_name;">
                  <option value="">None</option>
                  <tal:profile repeat="profile view/arprofiles">
                    <option
                      tal:content="string:${profile/Title}"
                      tal:attributes="
                        value profile/UID;
                        tabindex python:column*100+tabindex.next();">Title</option>
                  </tal:profile>
                </select>
              </td>
            </tal:block>
          </tr>
          <!-- Sample -->
          <tr tal:define="field_name string:SampleID"  tal:condition="not: edit">
            <th colspan="2"></th>
            <td class="center">&nbsp;</td>
            <tal:linksample repeat="column python:range(view.col_count)">
              <td class="center"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                            input_id string:ar_${column}_${field_name}">
                <!-- Contains translated button text for sample remove button js -->
                <input type="hidden" value="Select Sample"
                  i18n:attributes="value" i18n:domain="bika"
                  tal:attributes="id string:${input_id}_default;"/>
                <!-- Actual value for form is stored in hidden field -->
                <input type="hidden"
                  tal:attributes="id input_id;
                                  name input_name;"/>
                <input type="button" value="Select Sample"
                  i18n:attributes="value" i18n:domain="bika"
                  tal:attributes="id string:${input_id}_button;
                                  name string:${input_name}_button;
                                  tabindex python:column*100+tabindex.next();"/>
                <image class="deleteSampleButton"
                       style="display:none"
                       tal:attributes="
                            id string:deleteSampleButton_${column};
                            src string:${portal/absolute_url}/images/delete.png;
                            column column"/>
              </td>
            </tal:linksample>
          </tr>
          <!-- Client Order ID -->
          <tr tal:define="field_name string:ClientOrderNumber">
            <th colspan="2" i18n:translate="label_client_order_id">Client Order ID</th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input size="10" type='text' 
                  tal:attributes="
                    id input_id;name input_name;
                    tabindex python:column*100+tabindex.next();
                    value python: hasattr(context, 'getClientOrderNumber') and context.getClientOrderNumber() or ''"/>
              </td>
            </tal:block>
          </tr>
          <!-- Client Reference -->
          <tr tal:define="field_name string:ClientReference">
            <th colspan="2" i18n:translate="label_clientreference">Client Reference</th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input size="10" type='text'
                  tal:attributes="
                    id input_id;name input_name;
                    tabindex python:column*100+tabindex.next();
                    value python:hasattr(context, 'getSample') and context.getSample().getClientReference() or ''"/>
                  </td>
            </tal:block>
          </tr>
          <!-- Client Sample ID -->
          <tr tal:define="field_name string:ClientSampleID">
            <th colspan="2" i18n:translate="label_clientsampleid">Client Sample ID</th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input size="10" type='text'
                  tal:attributes="
                    id input_id;name input_name;
                    tabindex python:column*100+tabindex.next();
                    value python:hasattr(context, 'getSample') and context.getSample().getClientSampleID() or ''"/>
              </td>
            </tal:block>
          </tr>
          <!-- Date Sampled -->
          <tr tal:define="field_name string:DateSampled">
            <th colspan="2">
              <span i18n:translate="label_datesampled">Date sampled</span>&nbsp;
              <span class="fieldRequired" 
                    tal:condition="python:not edit"/>
            </th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input size="10" type='text' tal:condition="not: edit"
                  tal:attributes="
                    id input_id;name input_name;
                    tabindex python:column*100+tabindex.next();"/>
                <span tal:condition="python:edit"
                  tal:content="python:plone_view.toLocalizedTime(here.getSample().getDateSampled(), long_format=0)"/>
              </td>
            </tal:block>
          </tr>
          <!-- Date Requested -->
          <tr tal:define="field_name string:DateRequested" tal:condition="python:edit and review_state">
            <th colspan="2" i18n:translate="label_daterequested">Date requested</th>
            <td>&nbsp;</td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <span
                  tal:content="python:plone_view.toLocalizedTime(here.getDateRequested(), long_format=1)"/>
              </td>
            </tal:block>
          </tr>
          <!-- Sample ID -->
          <tr tal:condition="python:edit and review_state"
              tal:define="field_name string:SampleID;
                          sample here/getSample|nothing;">
            <th colspan="2"><span id="" i18n:translate="label_sampleid">Sample ID</span></th>
            <td>&nbsp;</td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <a href="" 
                    tal:attributes="href sample/getSampleID"
                    tal:content="sample/getSampleID">S-00001</a>
              </td>
            </tal:block>
          </tr>
          <!-- Sample Type -->
          <tr tal:define="field_name string:SampleType">
            <th colspan="2">
                <span id="" i18n:translate="label_sampletype">Sample type</span>
                &nbsp;<span class="fieldRequired"/>
            </th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input size="10" type='text' class='sampletype' tal:condition="not: edit"
                  tal:attributes="
                    id input_id;name input_name;
                    tabindex python:column*100+tabindex.next();"/>
                <span tal:condition="edit"
                  tal:content="python:here.getSample().getSampleType().Title()"/>
              </td>
            </tal:block>
          </tr>
          <!-- Sample Point -->
          <tr tal:define="field_name string:SamplePoint">
            <th colspan="2"><span id="" i18n:translate="label_samplepoint">Sample Point</span></th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input size="10" type='text' class="samplepoint" tal:condition="not: edit"
                  tal:attributes="
                    id input_id;name input_name;
                    tabindex python:column*100+tabindex.next();"/>
                <span tal:condition="edit"
                  tal:content="python:here.getSample().getSamplePoint().Title()"/>
              </td>
            </tal:block>
          </tr>
          <!-- Dry Matter -->
          <tr tal:define="field_name string:ReportDryMatter">
            <th colspan="2" i18n:translate="label_report_dm">Report as Dry Matter</th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input type="checkbox" 
                  class="cb"
                  value="checked"
                  tal:attributes="
                    checked python:edit and context.ReportDryMatter;
                    name input_name;
                    id input_id;
                    tabindex python:column*100+tabindex.next();"/>
              </td>
            </tal:block>
          </tr>
          <!-- Exclude from Invoice -->
          <tr tal:define="field_name string:InvoiceExclude">
            <th colspan="2" i18n:translate="label_invoice_exclude">Exclude from invoice</th>
            <td>
              <image class="copyButton" tal:condition="not: edit"
                tal:attributes="name field_name;src string:${portal/absolute_url}/images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                              input_id string:ar_${column}_${field_name}">
                <input type="checkbox" 
                  class="cb"
                  value="checked"
                  tal:attributes="
                    checked python:edit and context.InvoiceExclude;
                    name input_name;
                    id input_id;
                    tabindex python:column*100+tabindex.next();"/>
              </td>
            </tal:block>
          </tr>
        </thead>

        <tbody tal:define="cats view/Categories; 
                           selectedservices python:edit and view.SelectedServices() or '';">

          <input type="hidden" id="selectedservices" tal:attributes="value python:','.join([s[1] for s in selectedservices]);"/>

          <!-- -- -- Analyses -- -- -->

          <tal:pointofcapture repeat="poc python:cats.keys()">
            <tr class="PointOfCapture">
             <th colspan="3"><b tal:content="python:modules['Products.bika.config'].POINTS_OF_CAPTURE.getValue(poc)">Analyses</b></th>
             <th tal:attributes="colspan view/col_count"></th>
            </tr>

            <tal:categories repeat="cat python:cats[poc]">
              <thead>
                <tr class="analysiscategory" tal:attributes="name python:cat[1]+'_'+poc;
                                    id python:cat[1]+'_'+poc;
                                    class python: 'analysiscategory' + (edit and [cat[1],poc] in [[s[0],s[2]] for s in selectedservices] and ' prefill' or '')">
                  <th tal:attributes="colspan python:view.col_count+3">
                    <a tal:content="python:cat[0]">Category Title</a>
                  </th>
                </tr>
              </thead>
              <tbody class="analysisservices" tal:attributes="id python:cat[1]+'_'+poc+'_tbody'">
                <tr></tr>
              </tbody>
            </tal:categories>

          </tal:pointofcapture>

        </tbody>

        <tfoot>

          <tr>
            <th colspan="2"><b i18n:translate="label_subtotal">Subtotal</b></th>
            <th style="text-align:center" i18n:translate="label_currency_abbreviation">R</th>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_id string:ar_${column}_subtotal;
                              input_name string:ar.${column}.subtotal">
                <input class="price noborder" size="5" disabled="disabled"
                  tal:attributes="id string:${input_id}_display;"/>
                <input type="hidden"
                  tal:attributes="
                    id input_id;
                    name string:${input_name}:ignore_empty:record;"/>
              </td>
            </tal:block>
          </tr>
 
            <tr>
            <th colspan="2"><b i18n:translate="label_vat">VAT</b></th>
            <th style="text-align:center" i18n:translate="label_currency_abbreviation">R</th>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_id string:ar_${column}_vat;
                              input_name string:ar.${column}.vat">
                <input class="price noborder" size="5" disabled="disabled"
                  tal:attributes="id string:${input_id}_display;"/>
                <input type="hidden"
                  tal:attributes="
                    id input_id;
                    name string:${input_name}:ignore_empty:record;"/>
              </td>
            </tal:block>
          </tr>

          <tr>
            <th colspan="2"><b i18n:translate="label_total">Total</b></th>
            <th style="text-align:center" i18n:translate="label_currency_abbreviation">R</th>
            <tal:block repeat="column python:range(view.col_count)">
              <td tal:define="input_id string:ar_${column}_total;
                              input_name string:ar.${column}.total">
                <input class="price noborder" size="5" disabled="disabled"
                  tal:attributes="id string:${input_id}_display;"/>
                <input type="hidden"
                  tal:attributes="
                    id input_id;
                    name string:${input_name}:ignore_empty:record;"/>
              </td>
            </tal:block>
          </tr>

          <tr>
            <th colspan="3" i18n:translate="label_saveprofile">Save profile</th>
            <tal:save repeat="column python:range(view.col_count)">
              <td>
                <input type="text" size="10"
                  tal:define="
                    input_name string:ar.${column}.profileTitle"
                  tal:attributes="
                    id input_name;
                    name string:${input_name}:ignore_empty:record;"/>
              </td>
            </tal:save>
          </tr>
        </tfoot>

      </table>
    
      <table><tr><td>
        <input class="context allowMultiSubmit"
               type="submit" 
               value="Submit"/>
      </td><td>
        <span id="spinner" style="display:none">
          <img tal:attributes="src python:portal.absolute_url()+ '/images/spinner.gif';"/></span>
      </td></tr></table>

      <br/>

      <div class="discreeter"
           tal:define="portal context/@@plone_portal_state/portal">
        <!--<p tal:condition="dry_matter">
        <img src="" tal:attributes="src string:${view/portal/absolute_url}/dry.png">
        <span i18n:translate="disclaimer_can_be_dry">
        Can be reported as dry matter</span>
        </p>-->
        <p tal:condition="python:context.bika_settings.laboratory.getLaboratoryAccredited()">
          <img src="" tal:attributes="src string:${portal/absolute_url}/images/accredited.png">
          <span i18n:translate="disclaimer_accred">
            Methods included in the <tal:block replace="here/bika_settings/laboratory/AccreditationBody" i18n:name="accreditation_body"/> 
            schedule of Accreditation for this Laboratory. Analysis remarks are not accredited
          </span>
        </p>
        <p tal:condition="here/getMemberDiscountApplies">
          <span i18n:translate="disclaimer_discount">
            A discount of <tal:block replace="here/bika_settings/getMemberDiscount" i18n:name="discount"/>% applies to all items listed above
          </span>
        </p>
      </div>

    </form>
  </div>
</body>
</html>
