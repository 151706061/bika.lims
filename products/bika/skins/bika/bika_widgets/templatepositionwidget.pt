<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:tal="http://xml.zope.org/namespaces/tal"
   xmlns:metal="http://xml.zope.org/namespaces/metal"
   xmlns:i18n="http://xml.zope.org/namespaces/i18n"
   i18n:domain="plone">
 <head><title></title></head>
 <body>
  <metal:view_macro define-macro="view">
     <table class="listing nosort">

     </table>
  </metal:view_macro>

  <metal:edit_macro define-macro="edit">
   <metal:use use-macro="field_macro | context/widgets/field/macros/edit">
    <metal:body_macro fill-slot="widget_body"
      tal:define="
        sort_on python:(('Title', 'nocase', 'asc'),);
        standardstocks python:[p.getObject() for p in context.portal_catalog(portal_type='StandardStock')];
        standardstocks python:sequence.sort(standardstocks, sort_on);
        types context/getAnalysisTypes;
        num_positions request/NoOfPositions | python:0; 
        num_positions python:int(num_positions);
        current_rows field/getRow;
        display_rows python:widget.get_template_rows(num_positions, current_rows);
        analyses python:[s.UID() for s in context.getService()]">

      <div class="field">

         <label i18n:translate="label_numpositions">Number of Positions</label>
         <input name="NoOfPositions" size="3" value=""
                tal:attributes="value request/NoOfPositions | python:len(display_rows)"/> &nbsp
         <input type="submit" name="form.button.more"
                class="context" 
                i18n:attributes="value"
                value="Reset" />
      </div>
      <table
            summary="Worksheet template form"
            class="analysisrequest"
            style="margin-top:0;"
            cellpadding="0" cellspacing="0">

        <tr>
          <th i18n:translate="label_position">Pos</th>
          <th i18n:translate="label_type">Analysis Type</th>
          <th i18n:translate="label_standardstock">Standard stock</th>
          <th i18n:translate="label_duplicate_of">Dup of</th>
        </tr>

        <tr tal:repeat="row display_rows">
          <tal:type tal:define="type row/type">
            <td><span tal:content="row/pos"/>
                <input type="hidden" tal:attributes="value: row/pos" name="Row.pos:records:ignore_empty"/></td>
            <td>
              <select name="Row.type:records:ignore_empty" class="analysis_type" tal:attributes="pos row/pos;">
                  <tal:item 
                    tal:define="vocab types"
                    tal:repeat="item vocab">
                    <option selected="selected"
                      tal:define="this_selected python:item == type"
                      tal:attributes="
                              value item;
                              selected this_selected"
                      tal:content="python:context.translate(item, default=vocab.getValue(item))"></option>
                  </tal:item>
              </select>
            </td>

            <td>
                <div id="">
                    <select name="Row.sub:records:ignore_empty" 
                            tal:attributes="class string:sst_${row/pos};
                                            style python:row['type'] in ('b','c') and '' or 'display:none'"> 
                    <tal:item tal:repeat="sst standardstocks">
                    <option selected="selected"
                        tal:define="
                                sst_uid sst/UID;
                                this_selected python:sst_uid == row['sub']"
                        tal:attributes="
                                value sst_uid;
                                selected this_selected"
                        tal:content="sst/Title"></option>
                    </tal:item>
    
                    </select>
                </div>
            </td>
            <td>
                <div id="" tal:define="num_rows repeat/row/length">    
                    <select name="SubtypeDup" 
                            style="display:none"
                            tal:attributes="class string:dup_${row/pos};"> 
                        <tal:item tal:repeat="i python:range(1,(num_rows+1))">
                            <option selected="selected"
                                tal:condition="python:i <> repeat['row'].number()"
                                tal:define="this_selected python:str(i) == row['sub']"
                                tal:attributes="value i; selected this_selected"
                                tal:content="i"></option>
                        </tal:item>
                    </select>
                </div>
            </td>
          </tal:type>
        </tr>
      </table>

    </metal:body_macro>
   </metal:use>
  </metal:edit_macro>
</body>
</html>
