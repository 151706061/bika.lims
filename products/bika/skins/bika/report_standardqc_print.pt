<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<metal:block use-macro="here/global_defines/macros/defines" />

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      tal:attributes="lang default_language|default;
                      xml:lang default_language|default;"
      i18n:domain="bika">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"
          tal:define="charset site_properties/default_charset|string:utf-8"
          tal:attributes="content string:text/html;;charset=${charset}" />

    <!-- Column style sheet. -->
    <style type="text/css" media="all" tal:condition="exists: portal/ploneColumns.css"
           tal:content="string:@import url($portal_url/ploneColumns.css);">
    </style>

    <!-- Main style sheets for CSS2 capable browsers -->
    <style type="text/css" media="screen"
           tal:content="string: @import url($portal_url/plone.css);">
    </style>

    <!-- Alternate style sheets for the bigger/smaller text switcher -->
    <link rel="alternate stylesheet" type="text/css" media="screen" href="" tal:attributes="href string:$portal_url/ploneTextSmall.css" title="Small Text" />
    <link rel="alternate stylesheet" type="text/css" media="screen" href="" tal:attributes="href string:$portal_url/ploneTextLarge.css" title="Large Text" />

    <!-- Custom style sheet if available -->
    <style type="text/css" media="all" tal:condition="exists: portal/ploneCustom.css"
           tal:content="string:@import url($portal_url/ploneCustom.css);">
    </style>

    <!-- Style sheet used for printing -->
    <link rel="stylesheet" type="text/css" media="print" href=""
          tal:attributes="href string:$portal_url/plonePrint.css" />

    <!-- Internet Explorer CSS Fixes -->
    <tal:iefixstart replace="structure string:&lt;!--[if IE]&gt;" />
    <style type="text/css" media="all" tal:condition="exists: portal/ploneIEFixes.css"
           tal:content="string:@import url($portal_url/ploneIEFixes.css);">
    </style>
    <tal:iefixend replace="structure string:&lt;![endif]--&gt;" />

</head>
<body style="font-size: 100%" onload="this.print()">
<metal:block use-macro="here/report_print_header/macros/report_header"/>

<metal:block define-macro="header">
<h1>
<img src="standardsample.png" tal:attributes="src python:here.portal_types.getTypeInfo('StandardSample').getIcon()"/>
<span i18n:translate="heading_standardsample_qc"
    >Standard Sample QC</span>
</h1>
<p i18n:translate="description_standardanalysis_qc">Standard analysis quality control graphs
</p>
</metal:block>

<metal:block define-macro="subheader">
<div tal:define="
        fromdate request/getDateVerified_fromdate | nothing;
        todate request/getDateVerified_todate | nothing;
        status request/review_state | nothing;">
<div tal:condition="python:fromdate or todate">
<span i18n:translate="label_verified_date">Date verified</span>
<span tal:condition="fromdate"
    i18n:translate="label_from">from</span>
<span tal:condition="fromdate"
    tal:content="python:plone_view.toLocalizedTime(request.getDateVerified_fromdate, long_format=0)">2006-01-01 </span>
<span tal:condition="todate"
    i18n:translate="label_to">to</span>
<span tal:condition="todate"
        tal:content="python:plone_view.toLocalizedTime(request.getDateVerified_todate, long_format=0)">2006-01-01</span>
</div>
<div tal:condition="python:not (fromdate or todate)">
        <span i18n:translate="label_verified_date">Date verified</span>
<span i18n:translate="label_not_specified">not specified</span>
</div>
</div>
</metal:block>

<metal:block define-macro="body"
    tal:define="
    service_uid python:request.get('getServiceUID', '');
    supplier_uid python:request.get('getStandardSupplierUID', '');
    stdsample_uid python:request.get('getStandardSampleUID', '')">
<tal:no_values tal:condition="python:not service_uid or not supplier_uid or not stdsample_uid">
<b i18n:translate="label_values_not_specified">Specify all values</b>
</tal:no_values>

<tal:get_values tal:condition="python:service_uid and supplier_uid and stdsample_uid">
<div style="clear:both"/>
<table
    summary="Standard Analysis View"
    class="analysisrequest"
    cellpadding="0" cellspacing="0"
    width="100%"
    tal:define="
    toLocalizedTime nocall:context/@@plone/toLocalizedTime;
    datefrom request/getDateVerified_fromdate | nothing;
    dateto python:request.get('getDateVerified_todate', '');
    service python:here.reference_catalog.lookupObject(service_uid);
    selected_uid python:request.get('getAnalysisUID', '');
    selected_sa python:selected_uid and here.reference_catalog.lookupObject(selected_uid) or None;
    selected python:selected_sa and selected_sa.getResult() or None;
    selected_id python:selected_sa and selected_sa.getId() or None;
    supplier python:here.reference_catalog.lookupObject(supplier_uid);
    stdsample python:here.reference_catalog.lookupObject(stdsample_uid);
    dummy python:here.format_date_query('getDateVerified');
    sa_proxies python:here.queryCatalog() or [];
    all_analyses python:[p.getObject() for p in sa_proxies];
    analyses python:here.get_valid_analyses(all_analyses);
    sort_on python:(('getDateVerified', 'cmp', 'asc'),);
    analyses python:sequence.sort(analyses, sort_on);
    minresults python: context.bika_settings.settings.getMinimumResults() or 5;
    expected_result python:service and stdsample.getStandardResult(service_uid) or [0,0,0];
    expected python:expected_result[0];
    expected_min python:expected_result[1];
    expected_max python:expected_result[2];
    results python: [a.getResult() for a in analyses];
    verified_dates python: [toLocalizedTime(a.getDateVerified(), long_format=0) for a in analyses];
    yvalues python:','.join([str(v) for v in results]);
    xdates python:','.join([str(v) for v in verified_dates]);
">
<!--
    dummy1 python:request.set('yvalues', yvalues);
    dummy2 python:request.set('xdates', xdates);
    trend python:here.get_trend_chart_data();
<b tal:content="trend"/>
-->

<tr>
<th width="20%" i18n:translate="label_supplier">Supplier</th>
<td width="30%" class="left"
    tal:content="python:supplier.Title()"
    >Acme suppliers</td>
<th width="20%" i18n:translate="label_standardsample">Standard Sample</th>
<td class="left" width="30%">
<a  href=""
    tal:attributes="href string:${stdsample/absolute_url}"
    tal:content="stdsample/Title">S001</a></td>
</tr>

<tr>
<th width="20%" i18n:translate="label_stock">Stock</th>
<td width="30%" class="left"
    tal:content="python:stdsample.getStandardStock() and stdsample.getStandardStock().Title() or None"
    >4gl sugar</td>
<th i18n:translate="label_analysis">Analysis
</th>
<td class="left" width="30%"
    tal:define="category service/getCategoryName;
                title service/Title"
                tal:content="python:'%s: %s' %(category, title)">Acid</td>
</tr>
<tr>
<th i18n:translate="label_date_verified">Date verified
</th>
<td class="left" colspan="3">
<tal:datefrom tal:condition="datefrom">
<span i18n:translate="label_from">from</span>
<span tal:content="python:toLocalizedTime(datefrom, long_format=0)"></span>
</tal:datefrom>
<tal:dateto tal:condition="dateto">
<span i18n:translate="label_to">to</span>
<span tal:content="python:toLocalizedTime(dateto, long_format=0)"></span>
</tal:dateto>
<span tal:condition="python:not dateto and not datefrom"
    i18n:translate="label_not_specified">Not specified</span>
</td>
</tr>

<!-- distribution graph -->
<tr>
<tal:graph tal:condition="python: len(results) >= minresults">
<td colspan="4" width="100%" height="300px" style="vertical-align: middle">
<br/>
<h4 i18n:translate="label_distribution">Distribution</h4>
<img tal:define="c_url string:${here/portal_url}/charts/;
        xvalues python:','.join([str(v) for v in results])"
     tal:attributes="src string:${c_url}distribution?expected=${expected}&min=${expected_min}&max=${expected_max}&selected=${selected}&selected_id=${selected_id}&xvalues=${xvalues}"/>
</td>
</tal:graph>

<tal:nograph tal:condition="python: len(results) < minresults">
<td colspan="4" height="50px" style="vertical-align: middle">Distribution graph cannot be displayed, as the number of results for this analysis does not meet the minimum requirement</td>
</tal:nograph>
<br/>
</tr>

<!-- trend graph -->
<tr>
<tal:graph tal:condition="python: len(results) > 0">
<td colspan="4" width="100%" height="300px" style="vertical-align: middle">
<br/>
<h4 i18n:translate="label_trend">Result trend</h4>
<img tal:define="c_url string:${here/portal_url}/charts/;
        yvalues python:','.join([str(v) for v in results]);
        xdates python:','.join([str(v) for v in verified_dates])"
     tal:attributes="src string:${c_url}trendplot?expected=${expected}&min=${expected_min}&max=${expected_max}&selected_id=${selected_id}&yvalues=${yvalues}&xdates=${xdates}"/>
<br/>
</td>
</tal:graph>

</tr>

<!-- list of values -->
<tr style="border-top: hidden">
<td colspan="4">

<br/>
<h4 i18n:translate="label_all_values">All values</h4>
<CENTER>
<table class="listing"
       id="allvalues"
       cellpadding="0" cellspacing="0">

<thead>
<tr>
<th i18n:translate="label_analysis">Analysis</th>
<th i18n:translate="label_result_unit"
    tal:define="unit python:service and service.getUnit() or nothing">
Result <tal:block replace="unit" i18n:name="unit"/>
</th>
<th i18n:translate="label_verified">Verified</th>
</tr>
</thead>
<tbody>
<tal:analyses tal:repeat="analysis analyses">
<tal:block 
    tal:condition="analysis/getResult"
    tal:define="analysis_uid analysis/UID;
                selected_uid python:selected_sa and selected_sa.UID() or None">
<tr tal:attributes="class python: test((analysis_uid == selected_uid), 'specific', None)">
<td id="">
<a href="" 
    tal:attributes="href string:${stdsample/absolute_url}"
    tal:content="analysis/getId">SA-001</a>
</td>

<td tal:content="analysis/getResult">Result</td>
<td tal:define="date_verified analysis/getDateVerified"
    tal:content="python:toLocalizedTime(date_verified, long_format=0)"></td>
</tr>
</tal:block>
</tal:analyses>
</tbody>
</table>
</CENTER>

</td>
</tr>

</table>
</tal:get_values>
</metal:block>

</body>

</html>


