<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

<head><title></title>
    <metal:calendar fill-slot="javascript_head_slot">
        <!-- ECMAScript calendar -->
        <style type="text/css" media="all"
            tal:content="string:@import url($portal_url/jscalendar/calendar-system.css);"></style>
        <script type="text/javascript"
            tal:attributes="src string:$portal_url/jscalendar/calendar_stripped.js"></script>
        <script type="text/javascript" charset="iso-8859-1"
            tal:condition="exists: portal/jscalendar/calendar-en.js"
            tal:attributes="src string:$portal_url/jscalendar/calendar-en.js"></script>
    </metal:calendar>
</head>
<body>

<div metal:fill-slot="main"
    tal:define="
        manufacturers python:[p for p in here.portal_catalog(portal_type='StandardManufacturer')];
        sort_on python:(('Title', 'nocase', 'asc'),);
        manufacturers python:sequence.sort(manufacturers, sort_on);
        errors options/state/getErrors;
        stocks python:here.get_standardstock_results();
        st_uids stocks/uids;
        st_stocks stocks/std_stocks;
        analysis_specs python:here.getResultsRangeDict();
        old_cats python:here.getSpecCategories();
        analyses python:request.get('Service', []);
        categories python:[c for c in here.portal_catalog(portal_type='AnalysisCategory')];
        sort_on python:(('Title', 'nocase', 'asc'),);
        categories python:sequence.sort(categories, sort_on);
        selected_cats python:request.get('Categories', []);
        dummy python:selected_cats.extend(old_cats);
">


<script type="text/javascript" src="utils.js"></script>
<tal:error repeat="error python:errors.keys()">
<tal:x define="message python:errors[error]">
<p class="portalMessage">
<span tal:content="error">field</span>:
<span tal:content="message">Error</span> </p>
</tal:x>
</tal:error>
<div metal:use-macro="here/document_actions/macros/document_actions">
    Document actions (print, sendto etc)
</div>
<h1>
    <img src="ar.png" tal:attributes="src python:here.portal_types.getTypeInfo('StandardSample').getIcon()"/>
    <span tal:omit-tag="" i18n:translate="heading_standard"
        >Edit standard sample</span>
</h1>

<form name="edit_form"
    method="post"
    enctype="multipart/form-data"
    action=""
    tal:attributes="action python:here.absolute_url()+'/'+template.id"
    autocomplete="off">

<input type="hidden" name="form.submitted" value="1" />
<input type="hidden" name="came_from" value="edit" />
<input type="hidden" name="StandardSampleUID" value=""
    tal:attributes="value here/UID"/>
<input type="hidden" id="today" value=""
    tal:attributes="value python:DateTime().strftime('%Y/%m/%d')" />
<br/>

<table
    summary="Standard sample form"
    class="analysisrequest"
    cellpadding="0" cellspacing="0">
<thead>
<tr>
<th> 
<span i18n:translate="label_title">Title </span>
    &nbsp;<span class="fieldRequired"/>
</th>
<td class="left" colspan="5">
<input size="30" name="StandardDescription" value=""
    tal:attributes="value request/StandardDescription | here/getStandardDescription"/>
</td>
</tr>
<tr>
<th> 
<span i18n:translate="label_manufacturer">Manufacturer</span>
</th>
<td colspan="5" class="left"
    tal:define="this_manufacturer here/getStandardManufacturer | nothing;
                this_manufacturer_uid python:this_manufacturer and this_manufacturer.UID() or None;
                this_uid python:request.get('StandardManufacturer', None);
                this_uid python:test(this_uid, this_uid, this_manufacturer_uid)">
    <select name="StandardManufacturer" 
            id="stdmanufacturer"
        tal:attributes="tabindex tabindex/next;">
    <option tal:attributes="value python:'None'">None</option> 
    <tal:std_manufacturer 
        tal:repeat="manufacturer manufacturers">
    <option selected="selected"
        tal:define="
            mnf_title python:manufacturer.Title;
            mnf_UID python:manufacturer.UID;
            this_selected python:test(this_uid and (mnf_UID == this_uid), 'selected', '')"
        tal:attributes="value mnf_UID;
            selected this_selected"
        tal:content="mnf_title"></option>
    </tal:std_manufacturer>
    </select>
</td>
</tr>
<tr>
<th> 
<span i18n:translate="label_cataloguenumber">Catalogue number</span>
</th>
<td class="left" colspan="5">
<input size="30" name="CatalogueNumber" value=""
    tal:attributes="value request/CatalogueNumber | here/getCatalogueNumber"/>
</td>
</tr>
<tr>
<th> 
<span i18n:translate="label_lotnumber">Lot number</span>
</th>
<td class="left" colspan="5">
<input size="30" name="LotNumber" value=""
    tal:attributes="value request/LotNumber | here/getLotNumber"/>
</td>
</tr>
<tr>
<th> 
<span i18n:translate="label_standardstock">Standard stock </span>
</th>
<td colspan="5" class="left"
    tal:define="this_stock here/getStandardStock | nothing;
                this_stock_uid python:this_stock and this_stock.UID() or None;
                this_uid python:request.get('StandardStock', None);
                this_uid python:test(this_uid, this_uid, this_stock_uid)">
    <select name="StandardStock" 
            id="stdstock"
        tal:attributes="
            onChange string:setStockData();
            tabindex tabindex/next;">
    <option tal:attributes="value python:'None'">None</option> 
    <tal:std_stock 
        tal:repeat="uid st_uids">
    <option selected="selected"
        tal:define="
            sst_title python:st_stocks[uid]['title'];
            value python:st_stocks[uid]['uid'];
            this_selected python:test(this_uid and (st_stocks[uid]['uid'] == this_uid), 'selected', '')"
        tal:attributes="value value;
            selected this_selected"
        tal:content="sst_title"></option>
    </tal:std_stock>
    </select>
<tal:std_results
    tal:repeat="uid st_uids">
<input  type="hidden"
    tal:define="
        input_id string:stdstock.${uid}"
    tal:attributes="
        created python:st_stocks[uid]['created'];
        expiry python:st_stocks[uid]['expiry'];
        services python:st_stocks[uid]['services'];
        results python:st_stocks[uid]['results'];
        id input_id;
        "/>
</tal:std_results>
</td>
</tr>
<tr>
<th id="" i18n:translate="label_datesampled">Date sampled</th>
<td colspan="5" class="left">
<tal:define define="
    id string:DateSampled;
    inputname id;
    formname string:search;
    value request/DateSampled | here/getDateSampled;
    inputvalue python:test(value!='None', value, '');
    show_hm python:False">
<metal:use use-macro="here/calendar_macros/macros/calendarDatePickerBox">
    a calendar, hopefully
</metal:use>
</tal:define>
</td>
</tr>
<tr>
<th id="" i18n:translate="label_datereceived">Date received</th>
<td colspan="5" class="left">
<tal:define define="
    id string:DateReceived;
    inputname id;
    formname string:search;
    value request/DateReceived | here/getDateReceived;
    inputvalue python:test(value!='None', value, '');
    show_hm python:False">
<metal:use use-macro="here/calendar_macros/macros/calendarDatePickerBox">
    a calendar, hopefully
</metal:use>
</tal:define>
</td>
</tr>
<tr>
<th id="" i18n:translate="label_dateopened">Date opened</th>
<td colspan="5" class="left">
<tal:define define="
    id string:DateOpened;
    inputname id;
    formname string:search;
    value request/DateOpened | here/getDateOpened;
    inputvalue python:test(value!='None', value, '');
    show_hm python:False">
<metal:use use-macro="here/calendar_macros/macros/calendarDatePickerBox">
    a calendar, hopefully
</metal:use>
</tal:define>
</td>
</tr>
<tr>
<th id="" i18n:translate="label_expirydate">Expiry date</th>
<td colspan="5" class="left">
<tal:define define="
    id string:ExpiryDate;
    inputname id;
    formname string:search;
    value request/ExpiryDate | here/getExpiryDate;
    inputvalue python:test(value!='None', value, '');
    show_hm python:False">
<metal:use use-macro="here/calendar_macros/macros/calendarDatePickerBox">
    a calendar, hopefully
</metal:use>
</tal:define>
</td>
</tr>
</thead>
<tbody>
<tr>
<th colspan="2">
<b i18n:translate="label_analyses">Analyses</b> 
    &nbsp;<span class="fieldRequired"/>
</th>
<th align="center" i18n:translate="label_truevalue">True value</th>
<th align="center" i18n:translate="label_perc_error">% error</th>
<th align="center" i18n:translate="label_min">Min</th>
<th align="center" i18n:translate="label_max">Max</th>
</tr>
<tal:categories>
<tr>
<td class="category" colspan="6">
<input
    class="noborder"
    type="checkbox"
    id="AllCats"
    title="Expand all categories"
    onClick="selectAllCats('AllCats', 'Cat')"
    tal:attributes="
        tabindex tabindex/next"/>

<b i18n:translate="Categories">Categories</b>

</td>
</tr>

<tal:category tal:repeat="category categories">
<tr>
<td class="category" colspan="6">
&nbsp
<input
    class="noborder"
    type="checkbox"
    name="Categories:list"
    title="Expand"
    tal:define="this_checked python:category.UID in selected_cats;
                i repeat/category/index;
                this_id string:Cat$i"
    tal:attributes="
        id this_id;
        checked this_checked;
        value category/UID;
        tabindex tabindex/next"/>
<b tal:content="category/Title"/>

</td>
</tr>

<tal:services 
    tal:condition="python:category.UID in selected_cats">

<tal:service
    tal:define="
        all_services python:[s.getObject() for s in here.portal_catalog(portal_type='AnalysisService', getCategoryUID=category.UID)];
        services python:[s for s in all_services if s.getCalcType() != 'dep'];
        sort_on python:(('Title', 'nocase', 'asc'),);
        services python:sequence.sort(services, sort_on)"
    tal:repeat="service services">
<tr
    tal:define="unit service/getUnit;
                service_uid service/UID;
                entered python:service_uid in analyses;
                existing python:analysis_specs.has_key(service_uid);
                analysis_found python:entered or existing;
                spec_name string:spec.$service_uid;
                analysis_spec python:entered and request.get(spec_name, {'error':'', 'result':'', 'min':'', 'max':''}) or (existing and analysis_specs[service_uid])">
<th> 

<a  onClick=""
    title="Click for details"
    tal:attributes="onClick string:javascript:showMethod('$portal_url', '${service/getId}')"
    tal:content="service/Title">
Alcohol
</a>
<em tal:condition="python:unit">(<span tal:replace="unit">mg/l</span>)</em>
</th>
<td>
<input type="checkbox" name="Service:list"
    class="noborder"
    tal:define="input_id string:${service_uid};
                checked python:analysis_found"
    tal:attributes="
        id string:${service_uid};
        value service_uid;
        onClick string:toggleResults('${service_uid}');
        checked checked"/>
</td>
<td>
<input size="6" name="" 
    tal:define="
        input_name string:spec.${service_uid}.result;
        spec_result python:analysis_found and (analysis_spec.has_key('result') and analysis_spec['result'] or '') or '';
        style python:analysis_found and 'visibility:visible' or 'visibility:hidden'"
    tal:attributes="
        style style;
        id string:${service_uid}.result;
        name string:${input_name}:ignore_empty:record;
        onChange string:calcMinMax('${service_uid}');
        value python:request.get(input_name, spec_result)"/>
</td>
<td>
<input size="6" name=""
    tal:define="
        style python:analysis_found and 'visibility:visible' or 'visibility:hidden';
        spec_result python:analysis_found and (analysis_spec.has_key('error') and analysis_spec['error'] or '') or '';
        input_name string:spec.${service_uid}.error"
    tal:attributes="
        style style;
        id string:${service_uid}.error;
        name string:${input_name}:ignore_empty:record;
        onChange string:calcMinMax('${service_uid}');
        value python:request.get(input_name, spec_result)"/>
</td>
<td>
<input size="6" name="" 
    tal:define="
        style python:analysis_found and 'visibility:visible' or 'visibility:hidden';
        spec_min python:analysis_found and (analysis_spec.has_key('min') and analysis_spec['min'] or '') or '';
        input_name string:spec.${service_uid}.min"
    tal:attributes="
        style style;
        id string:${service_uid}.min;
        name string:${input_name}:ignore_empty:record;
        onChange string:clearError('${service_uid}');
        value python:request.get(input_name, spec_min)"/>
</td>
<td>
<input size="6" name=""
    tal:define="
        style python:analysis_found and 'visibility:visible' or 'visibility:hidden';
        spec_max python:analysis_found and (analysis_spec.has_key('max') and analysis_spec['max'] or '') or '';
        input_name string:spec.${service_uid}.max"
    tal:attributes="
        style style;
        id string:${service_uid}.max;
        name string:${input_name}:ignore_empty:record;
        onChange string:clearError('${service_uid}');
        value python:request.get(input_name, spec_max)"/>
</tr>
</tal:service>
</tal:services>
</tal:category>
</tal:categories>
</tbody>

</table>
<br/>

<label i18n:translate="label_remarks">Remarks</label>
<textarea name="Notes"
    tal:content="request/Notes|here/getNotes"></textarea>
<br/>
<br/>
<input class="context"
        type="submit"
        name="form.button.submit"
        value="Save"
        i18n:attributes="value"
        />
<input class="standalone"
        type="submit"
        name="form.button.cancel"
        value="Cancel"
        i18n:attributes="value"
        />
<input class="standalone"
        tabindex=""
        type="submit"
        name="form.button.category"
        value="expand"
        i18n:attributes="value"
        tal:attributes="tabindex tabindex/next"
        />
</form>

</div>

</body>

</html>


