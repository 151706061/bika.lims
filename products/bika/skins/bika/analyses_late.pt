<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

<head>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border', 1)" />
</head>
             
             
<body>

<div metal:fill-slot="main">

<h1>
<tal:block replace="structure python:getattr(here, here.getIcon(1))"/>
<span i18n:translate="heading_late_analyses">Late Analyses</span>
</h1>

<div metal:use-macro="here/document_actions/macros/document_actions">
Document actions (print, sendto etc)
</div>

<div id="content-lateanalyses"
     tal:define="DateTime python:modules['DateTime'].DateTime;
                 now python: DateTime();
                 results python:here.portal_catalog(
                    portal_type='Analysis',
                    getDueDate={'query': [now,], 'range': 'max'},
                    review_state=['assigned', 'sample_received', 'sample_due', 'to_be_verified', 'verified'],
                    sort_on='getDueDate');
                 Batch python:modules['Products.CMFPlone'].Batch;
                 b_start python:request.get('b_start',0);"
     tal:condition="python:results and member.has_role(('Manager', 'LabManager', 'LabClerk'))">
<form name="lateanalyses" action="." method="post" tal:condition="results"
    tal:define="batch python:Batch(results, 15, int(b_start), orphan=1)">

<table
    class="listing"
    summary="analysis request listing"
    cellpadding="0" cellspacing="0">

<thead>
<tr>
<th i18n:translate="label_analysis">Analysis</th>
<th i18n:translate="label_requestid">Request ID</th>
<th i18n:translate="label_client">Client</th>
<th i18n:translate="label_contact">Contact</th>
<th i18n:translate="label_datereceived">Date received</th>
<th i18n:translate="label_datedue">Date due</th>
<th i18n:translate="label_hourslate">Late</th>
</tr>
</thead>

<tbody>

<metal:block tal:repeat="result batch">
<tal:item define="item result/getObject">
<tr tal:define="
        oddrow repeat/result/odd;
        item_title_or_id item/title_or_id;
        ar python:item.aq_parent"
    tal:attributes="
        class python:test(oddrow, 'even', 'odd')" >
<td tal:content="item/Title">Alcohol</td>
<td>
<a href="" 
    tal:attributes="href ar/absolute_url"
    tal:content="ar/getRequestID">AR-00001</a>
</td>
<td tal:define="client python:ar.aq_parent"
    tal:content="client/Title">Client</td>
<td tal:define="contact ar/getContact"
    tal:content="contact/Title|nothing">Pete Smith</td>
<td tal:content="python:plone_view.toLocalizedTime(ar.getDateReceived(), long_format=1)"
    >2005-01-01 10:10</td>
<td tal:content="python:plone_view.toLocalizedTime(item.getDueDate(), long_format=1)"
    >2005-01-01 10:10</td>
<td tal:define="days_hours_late python:now - item.getDueDate();
                days_late python:int(days_hours_late // 1);
                hours_late python:int((days_hours_late % 1) * 24);
                mins_late python:int((((days_hours_late % 1) * 24) % 1) * 60)">
<tal:days condition="python:days_late != 0">
<span tal:content="days_late"/>
<span i18n:translate="label_days"
      tal:condition="python:days_late > 1">days</span>
<span i18n:translate="label_day"
      tal:condition="python:days_late == 1">day</span>
</tal:days>
<tal:hours condition="python:hours_late != 0">
<span tal:content="hours_late"/>
<span i18n:translate="label_hours"
      tal:condition="python:hours_late > 1">hours</span>
<span i18n:translate="label_hour"
      tal:condition="python:hours_late == 1">hour</span>
</tal:hours>
<tal:minutes condition="python:days_late ==0 and hours_late == 0">
<span tal:content="mins_late"/>
<span i18n:translate="label_minute">min</span>
</tal:minutes>
</td>
</tr>
</tal:item>
</metal:block>

</tbody>

</table>
<!-- Navigation -->
<div metal:use-macro="here/batch_macros/macros/navigation" />



</form>

</div>
</div>

</body>
</html>
