<html
    xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
    i18n:domain="bika"
    metal:use-macro="here/main_template/macros/master">

<head> </head>

<body>

<div metal:fill-slot="main">
<h1>
<tal:block replace="structure python:getattr(here, here.getIcon(1))"/>
<span tal:content="here/title_or_id" tal:omit-tag="">Directory Id</span>
-
<span i18n:translate="label_add_duplicate">Add duplicate analyses</span>
</h1>
<metal:block 
    tal:define="
        selected_uid python:request.get('AR', '');
        selected_ar python:selected_uid and here.reference_catalog.lookupObject(selected_uid);
        ars python:here.getAnalysisRequests()">

<form action="" method="post" name="search"
    tal:attributes="action template/getId">

<table
    class="listing" 
    cellspacing="0" 
    cellpadding="5"
    tal:condition="ars">
<thead>
<tr>
<th colspan="4" class="nosort" align="left">
<b i18n:translate="label_analysisrequests">Analysis Requests</b>
 &nbsp;<span class="fieldRequired"/>
</th>
</tr>
<tr>
<th class="nosort" >Select </th>
<th i18n:translate="label_requestid">Request ID</th>
<th i18n:translate="label_client">Client</th>
<th i18n:translate="label_daterequested">Date Requested</th>
</tr>
</thead>

<tbody>
<tal:results tal:repeat="ar ars">
<tr tal:define="oddrow repeat/ar/odd"
    tal:attributes="class python:test(oddrow, 'even', 'odd')">
<td>
<input type="radio" class="noborder" name="AR" value="#"
    tal:attributes="value ar/UID;
            checked python:selected_uid == ar.UID() and 'checked' or None;
            onClick string:this.form.submit()"/>
</td>
<td><a href="#"
    tal:attributes="href ar/absolute_url"
    tal:content="ar/getRequestID">AR-00001</a>
</td>
<td tal:content="python:ar.aq_parent.Title()"/>
<td tal:define="d ar/getDateRequested">
<span tal:condition="d"
    tal:content="python:plone_view.toLocalizedTime(d, long_format=0)"/></td>
</tr>
</tal:results>
</tbody>
</table>
</form>
<form action="assignDuplicate" method="post"
    tal:condition="selected_uid"
    tal:attributes="action string:${here/absolute_url}/assignDuplicate">

<tal:services
    tal:define="
        ar_stuff python:here.getARServices(selected_ar.getRequestID());
        services python:ar_stuff['services'];
        duplicates python:ar_stuff['dup_uids'];
        pos python:ar_stuff['pos'];
        sort_on python:(('getCategoryName', 'nocase', 'asc'),('Title', 'nocase', 'asc'),);
        services python:sequence.sort(services, sort_on);
        global category python:None ">

<table
    summary="Analysis profile form"
    class="bikatable"
    cellpadding="0" cellspacing="0">

<thead>
<tr>
<th colspan="2" class="nosort" align="left">
<b i18n:translate="label_analyses">Analyses</b>
 &nbsp;<span class="fieldRequired"/>
</th>
</tr>
</thead>
<tbody>
<tal:services tal:repeat="service services">
<tr 
    tal:condition="python:service.getCategoryName() != category">
<td colspan="2" class="category" 
    tal:content="service/getCategoryName">cat</td>
</tr>
<tr>
<tal:service
    tal:define="unit service/getUnit;
                service_uid service/UID;
                global category python:service.getCategoryName()">
<th> 
<a  onClick=""
    title="Click for details"
    tal:attributes="onClick string:javascript:showMethod('$portal_url', '${service/getId}')"
    tal:content="service/Title">
Alcohol
</a>
<em tal:condition="python:unit">(<span tal:replace="unit">mg/l</span>)</em>
</th>
<tal:x
    tal:define="item_no repeat/service/index">
<td>
<input type="checkbox" name="Service:list" 
       class="noborder"
       value=""
       tal:attributes="
            disabled python:service_uid in duplicates and 'disabled' or '';
            value python:service_uid"
/>
</td>
<td class="noborder">
<span tal:condition="python:service_uid in duplicates"
    i18n:translate="label_already_assigned">already assigned</span>
</td>
</tal:x>
</tal:service>
</tr>
</tal:services>

</tbody>

</table>


<input type="HIDDEN" name="AR" value=""
    tal:attributes="value selected_uid"/>
<input type="HIDDEN" name="Position" value=""
    tal:attributes="value pos"/>
</tal:services>
<input
    class="context"
    type="submit"
    name=""
    value="Add duplicate analyses"
    i18n:attributes="value"/>
</form>


</metal:block>

</div>

</body>
</html>
