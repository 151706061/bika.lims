<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

<head><title></title></head>
<body>
<div metal:fill-slot="main"
    tal:define="
        sort_on python:(('Title', 'nocase', 'asc'),);
        errors options/state/getErrors;
        selected_cats python:request.get('Categories', []);
        restrict_cats python:here.getRestrictCategories();
        old_cats python:here.getSpecCategories();
        default_cats python:[c.UID() for c in here.getDefaultCategory()];
        active_restricted python:not selected_cats and [c for c in old_cats if c not in default_cats];
        dummy python:not restrict_cats and default_cats.extend(active_restricted);
        all_cats python:restrict_cats and default_cats or [c.UID for c in here.portal_catalog(portal_type='AnalysisCategory')];
        expand_cats python:selected_cats and selected_cats or default_cats;
        errors options/state/getErrors;
        current_uid here/getSampleTypeUID | nothing;
        sampletypes python:here.getRemainingSampleTypes(current_uid);
        analysis_specs python:here.getResultsRangeDict();
        ">

<script type="text/javascript" src="utils.js"></script>
<tal:restricted tal:condition="python:restrict_cats and active_restricted">
<tal:cat repeat="cat_uid active_restricted">
<tal:x tal:define="cat python:here.portal_catalog(portal_type='AnalysisCategory', UID=cat_uid)[0]">
<p class="portalMessage">
<span i18n:translate="warning_restricted_category">Restricted category</span>
<span tal:content="cat/Title">cat</span>
<span i18n:translate="warning_contains_active">contains active analyses which will be lost on modification</span>
</p>
</tal:x>
</tal:cat>
</tal:restricted>

<tal:error repeat="error python:errors.keys()">
<tal:x define="message python:errors[error]">
<p class="portalMessage">
<span tal:content="error">field</span>:
<span tal:content="message">Error</span> </p>
</tal:x>
</tal:error>

<div metal:use-macro="here/document_actions/macros/document_actions">
    Document actions (print, sendto etc)
</div>
<h1>
    <img src="analysisspec.png" tal:attributes="src python:here.portal_types.getTypeInfo('AnalysisSpec').getIcon()"/>
    <span tal:omit-tag="" i18n:translate="heading_analysis_spec_edit"
        >Edit analysis specification</span>
</h1>

<form name="edit_form"
    method="post"
    enctype="multipart/form-data"
    action=""
    tal:attributes="action python:here.absolute_url()+'/'+template.id"
    autocomplete="off">

<input type="hidden" name="form.submitted" value="1" />
<input type="hidden" name="came_from" value="edit" />
<input type="hidden" name="AnalysisSpecUID" value=""
    tal:attributes="value here/UID"/>

<br/>

<table
    summary="Analysis spec form"
    class="analysisrequest"
    cellpadding="0" cellspacing="0">

<thead>

<tr>
<th> 
<span i18n:translate="label_sampletype">Sample type</span>
    &nbsp;<span class="fieldRequired"/>
</th>
<td colspan="3"
    tal:define="uid request/getSampleType| current_uid">
    <select name="SampleType"> 

    <tal:item 
        tal:define="
            vocab sampletypes"
        tal:repeat="item vocab">
    <option selected="selected"
        tal:define="
                this_selected python:test(uid and (item == uid), 'selected', '')"
        tal:attributes="value item;
            selected this_selected"
        tal:content="python:here.translate(vocab.getMsgId(item), default=vocab.getValue(item))"></option>
    </tal:item>

    </select>
</td>
</tr>
</thead>
<tbody>

<tr>
<th>
<b i18n:translate="label_analyses">Analyses</b> </th>
<th align="center" i18n:translate="label_min">Min</th>
<th align="center" i18n:translate="label_max">Max</th>
<th align="center" i18n:translate="label_perc_error">% error</th>
</tr>

<tal:categories    
tal:define="
        display_cats python:here.portal_catalog(portal_type='AnalysisCategory', UID=all_cats, sort_on='sortable_title')">
<tr>
<td class="category" colspan="4">
<input
    tal:condition="not:restrict_cats"
    class="noborder"
    type="checkbox"
    id="AllCats"
    title="Expand all categories"
    onClick="selectAllCats('AllCats', 'Cat')"
    tal:attributes="
        tabindex tabindex/next"/>

<b i18n:translate="Categories">Categories</b>

</td>
</tr>

<tal:category tal:repeat="category display_cats">
<tr>
<td class="category" colspan="4">
&nbsp
<input
    tal:condition="not:restrict_cats"
    class="noborder"
    type="checkbox"
    name="Categories:list"
    title="Expand"
    tal:define="this_checked python:category.UID in expand_cats;
                i repeat/category/index;
                this_id string:Cat$i"
    tal:attributes="
        id this_id;
        checked this_checked;
        value category/UID;
        tabindex tabindex/next"/>
<input 
    tal:condition="restrict_cats"
    class="noborder"
    type="hidden"
    name="Categories:list"
    title="Expand"
    tal:define="this_checked python:category.UID in expand_cats;
                i repeat/category/index;
                this_id string:Cat$i"
    tal:attributes="
        id this_id;
        checked this_checked;
        value category/UID;
        tabindex tabindex/next"/>
<b tal:content="category/Title"/>

</td>
</tr>
<tal:services 
    tal:condition="python:category.UID in expand_cats">
<tal:service 
    tal:define="
        services python:[s.getObject() for s in here.portal_catalog(portal_type='AnalysisService', getCategoryUID=category.UID)];
        sort_on python:(('Title', 'nocase', 'asc'),);
        services python:sequence.sort(services, sort_on)"

    tal:repeat="service services">





<tr tal:define="
        unit service/getUnit;
        service_uid service/UID;
        spec_found python:analysis_specs.has_key(service_uid);
        analysis_spec python:spec_found and analysis_specs[service_uid];
                ">
<th> 
<a  onClick=""
    title="Click for details"
    tal:attributes="onClick string:javascript:showMethod('$portal_url', '${service/getId}')"
    tal:content="service/Title">
Alcohol
</a>
<em tal:condition="python:unit">(<span tal:replace="unit">mg/l</span>)</em>
</th>
<td>
<input size="6" name=""
    tal:define="
        input_name string:analysisspec.${service_uid}.min;
        spec_min python:spec_found and analysis_spec['min'] or ''"
    tal:attributes="
        name string:${input_name}:ignore_empty:record;
        value python:request.get(input_name, spec_min)"/>
</td>
<td>
<input size="6" name=""
    tal:define="
        input_name string:analysisspec.${service_uid}.max;
        spec_max python:analysis_spec and analysis_spec['max'] or ''"
    tal:attributes="
        name string:${input_name}:ignore_empty:record;
        value python:request.get(input_name, spec_max)"/>
</td>
<td>
<input size="6" name=""
    tal:define="
        input_name string:analysisspec.${service_uid}.error;
        spec_error python:analysis_spec and analysis_spec['error'] or ''"
    tal:attributes="
        name string:${input_name}:ignore_empty:record;
        value python:request.get(input_name, spec_error)"/>
</td>
</tr>
</tal:service>
</tal:services>
</tal:category>
</tal:categories>

</tbody>

</table>

<br/>
<input class="context"
        name="form.button.submit"
        type="submit"
        value="Save"
        i18n:attributes="value"
        />
<input class="standalone"
        type="submit"
        name="form.button.cancel"
        value="Cancel"
        i18n:attributes="value"
        />
<input class="standalone"
        tal:condition="not:restrict_cats"
        tabindex=""
        type="submit"
        name="form.button.category"
        value="expand"
        i18n:attributes="value"
        tal:attributes="tabindex tabindex/next"
        />
</form>

</div>

</body>

</html>


