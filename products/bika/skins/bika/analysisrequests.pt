<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

<head>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border', 1)" />
</head>
             
             
<body>

<div metal:fill-slot="main" 
    tal:define="
        batch_size python:int(request.get('batch_size', '15'));
        dummy_a python:request.set('portal_type', 'AnalysisRequest');
        dummy_b python:request.set('sort_on', 'getRequestID');
        dummy_c python:request.set('sort_order', 'reverse');
        dummy_d python:here.toggle_state('analysis_review_state', 'all');
        analysis_state python:request.get('analysis_review_state');
        dummy_e python:here.REQUEST.set('review_state', analysis_state);
        states python:here.get_toggles('analysisrequest');
        header_state python:here.get_toggle_title(analysis_state, states)">

<div metal:use-macro="here/document_actions/macros/document_actions">
Document actions (print, sendto etc)
</div>

<h1>
<img src="ar.png" tal:attributes="src python:here.portal_types.getTypeInfo('AnalysisRequest').getIcon()"/>
<span i18n:translate="heading_analysis_requests">Analysis requests</span>
<tal:not_all tal:condition="python:analysis_state != 'all'">
-
<span i18n:translate="" tal:content="header_state">All</span>
</tal:not_all>
</h1>


<div metal:use-macro="here/batchsize_macros/macros/batchsize" />
<br/><br/>

<form name="filter_result" action="" method="post"
    tal:attributes="action template/getId">
<input type="hidden" name="portal_type" value="AnalysisRequest"/>
<input type="hidden" name="sort_on" value="getRequestID"/>
<input type="hidden" name="sort_order" value="reverse"/>
<div class="optionsToggle">
    <tal:x repeat="state states">
    <input class="noborder" type="radio" name="analysis_review_state" value="sample_due"
        onclick="this.form.submit()"
        tal:define="state_id state/id"
        tal:attributes="value state_id;
            checked python:request.get('analysis_review_state', 'all') == state_id and 'checked' or None"/>
    <span tal:content="state/title" i18n:translate="">Sample due</span>
    </tal:x>
</div>
</form>

<div id="content-analysisrequests"
     tal:define="
        all python:analysis_state == 'all';
        to_be_verified python:analysis_state == 'to_be_verified';
        results python:test(all, here.portal_catalog(
                    portal_type='AnalysisRequest',
                    sort_on='getRequestID',
                    sort_order='reverse'), 
                    container.queryCatalog());
        Batch python:modules['Products.CMFPlone'].Batch;
        b_start python:request.get('b_start',0);">

<form name="analysisrequests" action="." method="post" tal:condition="results"
    tal:define="batch python:Batch(results, batch_size, int(b_start), orphan=1)">

<input type="hidden" name="form.submitted" value="1" />

<div tal:define="ar_actions python:test(not to_be_verified, portal.portal_actions.listFilteredActionsFor(batch[0].getObject()));
                 ar_workflow_actions python:to_be_verified and here.get_all_filtered_actions(batch) or ar_actions['workflow'];
                 ar_action python:ar_workflow_actions and ar_workflow_actions[0]['id'] != 'assign' and not all">

<table
    class="listing"
    summary="analysis request listing"
    cellpadding="0" cellspacing="0">

<thead>
<tr>
<th class="nosort"
    tal:condition="ar_action">
<input
    class="noborder"
    type="checkbox"
    src="select_all_icon.gif"
    name="selectButton"
    title="Select all items"
    onClick="toggleSelect(this);"
    tal:attributes="src string:$portal_url/select_all_icon.gif"
    alt="Select all items"
    i18n:attributes="title; alt"
    />
</th>
<th i18n:translate="label_requestid">Request ID</th>
<th i18n:translate="label_client">Client</th>
<th i18n:translate="label_contact">Contact</th>
<th i18n:translate="label_clientorder">Client Order</th>
<th i18n:translate="label_clientref">Client Ref</th>
<th i18n:translate="label_clientsid">Client Sample</th>
<th i18n:translate="label_sampletype">Sample Type</th>
<th i18n:translate="label_samplepoint">Sample Point</th>
<th i18n:translate="label_datereceived"
    tal:condition="python:analysis_state != 'sample_due'">Date received</th>
<th i18n:translate="label_datepublished"
   tal:condition="python:analysis_state in ['published', 'all']">Date published</th>
<th i18n:translate="label_status"
    tal:condition="python:analysis_state == 'all'">Status</th>
<th i18n:translate="label_submitted_by"
    tal:condition="to_be_verified">Submitted by</th>
</tr>
</thead>

<tbody tal:define="getRelativeContentURL nocall:utool/getRelativeContentURL">

<metal:block tal:repeat="result batch">
<tal:item define="item result/getObject;
                  sample item/getSample;
                  sampletype sample/getSampleType;
                  ar_state python:test(analysis_state == 'all', 
                        wtool.getInfoFor(item, 'review_state', ''), 
                        analysis_state);
                  in_progress python:ar_state not in ['sample_due', 'published']">
<tr tal:define="
        oddrow repeat/result/odd;
        item_title_or_id item/title_or_id;"
    tal:attributes="
        class python:test(oddrow, 'even', 'odd')" >
<td tal:condition="ar_action">
<input type="checkbox" class="noborder" name="ids:list" id="#" value="#"
    tal:attributes="
        value item/UID;
        id python: 'cb_'+item.getId();
        checked request/ids_checked|nothing;
        tabindex tabindex/next|nothing;
        alt string:Select $item_title_or_id;
        title string:Select $item_title_or_id"/>
<input type="hidden" name="obj_paths:list" value="#"
    tal:attributes="value python:getRelativeContentURL(item)" />
</td>

<td style="white-space:nowrap">
<a href="" 
    tal:attributes="href item/absolute_url"
    tal:content="item/getRequestID">AR-00001</a>
<a href="" 
    tal:attributes="href sample/absolute_url">
<img src="" 
    alt="Sample"
    tal:attributes="src string:${portal/absolute_url}/sample_small.png">
</a>
<img src="" 
    tal:condition="sampletype/getHazardous"
    tal:attributes="src string:${portal/absolute_url}/hazardous_small.png">
<tal:late tal:condition="in_progress">
<img src="" 
    tal:condition="item/getLate"
    tal:attributes="src string:${portal/absolute_url}/late_small.png">
</tal:late>
</td>
<td tal:define="client nocall:item/aq_parent">
<a href=""
    tal:define="client_base string:${client/absolute_url}/base_edit"
    tal:attributes="href client_base"
    tal:content="client/Title">Client</a>
</td>
<td tal:define="contact item/getContact">
<a href=""
    tal:attributes="href contact/absolute_url"
    tal:content="contact/Title|nothing">Pete Smith</a></td>

<td tal:content="item/getClientOrderNumber">R001</td>
<td tal:content="sample/getClientReference">R001</td>
<td tal:content="sample/getClientSampleID">S001</td>
<td tal:content="sampletype/Title|nothing">SampleType</td>
<td tal:define="samplepoint sample/getSamplePoint"
    tal:content="samplepoint/Title|nothing">SamplePoint</td>
<td tal:condition="python:analysis_state != 'sample_due'"> 
<span tal:condition="python:ar_state != 'sample_due'"
    tal:content="python:plone_view.toLocalizedTime(item.getDateReceived(), long_format=1)"
    >2005-01-01 10:10</span>
</td>
<td tal:condition="python:analysis_state in ['published', 'all']"> 
<span tal:condition="python:ar_state in 'published'" 
      tal:content="python:plone_view.toLocalizedTime(item.getDatePublished(), long_format=1)"
    >2005-01-01 10:10</span>
</td>
<td tal:condition="python:analysis_state == 'all'" 
    tal:content="python:ar_state.replace('_', ' ')">
</td>
<td tal:condition="to_be_verified"
    tal:define="submitters python:here.get_submitted_by(item)">
<div tal:repeat="submitter submitters"
    tal:content="submitter"></div>
</td>
</tr>
</tal:item>
</metal:block>

</tbody>

</table>


<!-- Navigation -->

<div metal:use-macro="here/batch_macros/macros/navigation" />

<tal:ar_actions
    condition="python:batch and not all">

<input type="hidden" id="workflow_action" name="workflow_action" value=""/>

<tal:buttons tal:repeat="transition ar_workflow_actions"
    tal:define="published python:analysis_state in ['published']">

<input
    class="worksheet"
    type="submit"
    name="batch_status_modify:method"
    value=""
    tabindex=""
    tal:condition="python:published or (transition['id'] not in ['assign', 'prepublish', 'submit'])"
    i18n:attributes="value"
    tal:attributes="
        value transition/name;
        tabindex tabindex/next;
        onclick string:this.form.workflow_action.value = '${transition/id}'" />


</tal:buttons>
</tal:ar_actions>
</div>

</form>

</div>
</div>

</body>
</html>
