<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

<head>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border', 1)" />
</head>
             
             
<body>

<div metal:fill-slot="main">

<script type="text/javascript" src="utils.js"></script>

<tal:format_date_query define="dummy python:here.format_date_query('DateSampled')"/>
<tal:format_date_query define="dummy python:here.format_date_query('getDateRequested')"/>
<tal:format_date_query define="dummy python:here.format_date_query('getDateReceived')"/>
<tal:format_date_query define="dummy python:here.format_date_query('getDatePublished')"/>


<!-- actual list of objects, either searchresults or folder contents -->
<tal:block
    tal:define="
        lab_accredited python:context.bika_labinfo.laboratory.getLaboratoryAccredited();
        results python:here.query_analysis_requests() or [];
        b_start python:0;
        b_start request/b_start | b_start;
        b_size python:6;
        Batch python:modules['Products.CMFPlone'].Batch;
        batch python:Batch(results, b_size, int(b_start), orphan=1);
        ar_batch python:[b.getObject() for b in batch];
        global tf python:0;
        global nr python:0;
        global any_mou python:0;
        global out_of_range python:0;
        global dry_matter python:0;
        global invoice_exclude python:0;
        global columns python:0;
        is_client here/member_is_client;
        default_spec python:test(is_client, 'client', 'lab');
        query_client request/getClientUID | nothing;
        query_contact request/getContactUID | nothing;
        specification python:request.get('specification', default_spec)">


<h1 i18n:translate="heading_search_results">Search results</h1>

<metal:email_result
    tal:define="mail_template string:ar_query_results;
                date_index string:getDateRequested"
    tal:condition="results">
    <metal:block use-macro="here/email_results_form/macros/body"/>
</metal:email_result>

<div tal:condition="not: results">
    <p><strong i18n:translate="description_no_results_found">No results were found.</strong></p>
</div>

<strong tal:condition="results">
<span i18n:translate="batch_x_items_matching_your_criteria"><span i18n:name="number" tal:content="python:len(results)">234</span> items matching your criteria.</span>
</strong>

<form name="specificationForm"
    method="post"
    action="."
    tal:attributes="action string:${here_url}/query_analysisrequest_results">

<!-- repost query values for specification change -->
<input type="hidden" name="getClientUID" value=""
    tal:condition="request/getClientUID | nothing"
    tal:attributes="value request/getClientUID | nothing"/> 
<input type="hidden" name="getContactUID" value=""
    tal:condition="request/getContactUID | nothing"
    tal:attributes="value request/getContactUID | nothing"/> 
<input type="hidden" name="getProfileUID" value=""
    tal:condition="request/getProfileUID | nothing"
    tal:attributes="value request/getProfileUID | nothing"/> 
<input type="hidden" name="getRequestID" value=""
    tal:condition="request/getRequestID | nothing"
    tal:attributes="value request/getRequestID | nothing"/> 
<input type="hidden" name="ClientReference" value=""
    tal:condition="request/ClientReference | nothing"
    tal:attributes="value request/ClientReference | nothing"/> 
<input type="hidden" name="ClientSampleID" value=""
    tal:condition="request/ClientSampleID | nothing"
    tal:attributes="value request/ClientSampleID | nothing"/> 
<input type="hidden" name="SampleTypeUID" value=""
    tal:condition="request/SampleTypeUID | nothing"
    tal:attributes="value request/SampleTypeUID | nothing"/> 
<input type="hidden" name="SamplePointUID" value=""
    tal:condition="request/SamplePointUID | nothing"
    tal:attributes="value request/SamplePointUID | nothing"/> 
<input type="hidden" name="SubmittedByUser" value=""
    tal:condition="request/SubmittedByUser | nothing"
    tal:attributes="value request/SubmittedByUser | nothing"/> 

<input type="hidden" name="getDateSampled_fromdate" value=""
    tal:condition="request/getDateSampled_fromdate | nothing"
    tal:attributes="value request/getDateSampled_fromdate | nothing"/> 
<input type="hidden" name="getDateSampled_todate" value=""
    tal:condition="request/DateSampled_todate | nothing"
    tal:attributes="value request/getDateSampled_todate | nothing"/> 

<input type="hidden" name="getDateRequested_fromdate" value=""
    tal:condition="request/getDateRequested_fromdate | nothing"
    tal:attributes="value request/getDateRequested_fromdate | nothing"/> 
<input type="hidden" name="getDateRequested_todate" value=""
    tal:condition="request/DateRequested_todate | nothing"
    tal:attributes="value request/getDateRequested_todate | nothing"/> 

<input type="hidden" name="getDateReceived_fromdate" value=""
    tal:condition="request/getDateReceived_fromdate | nothing"
    tal:attributes="value request/getDateReceived_fromdate | nothing"/> 
<input type="hidden" name="getDateReceived_todate" value=""
    tal:condition="request/DateReceived_todate | nothing"
    tal:attributes="value request/getDateReceived_todate | nothing"/> 

<input type="hidden" name="getDatePublished_fromdate" value=""
    tal:condition="request/getDatePublished_fromdate | nothing"
    tal:attributes="value request/getDatePublished_fromdate | nothing"/> 
<input type="hidden" name="getDatePublished_todate" value=""
    tal:condition="request/DatePublished_todate | nothing"
    tal:attributes="value request/getDatePublished_todate | nothing"/> 

<input type="hidden" name="CategoryUID" value=""
    tal:condition="request/CategoryUID | nothing"
    tal:attributes="value request/CategoryUID | nothing"/> 
<input type="hidden" name="ServiceUID" value=""
    tal:condition="request/ServiceUID | nothing"
    tal:attributes="value request/ServiceUID | nothing"/> 
<input type="hidden" name="review_state" value=""
    tal:condition="request/review_state | nothing"
    tal:attributes="value request/review_state | nothing"/> 
<input type="hidden" name="b_start" value=""
    tal:condition="request/b_start | nothing"
    tal:attributes="value request/b_start | nothing"/> 

<span i18n:translate="label_range_specification">Range Specification</span>: 
<input class="noborder" type="radio" name="specification" value="lab"
    onclick="this.form.submit()"
    tal:attributes="
        checked python:test(specification == 'lab',  'checked', None);
        tabindex tabindex/next"/>
<label i18n:translate="label_lab"
    >Lab</label>
<input class="noborder" type="radio" name="specification" value="client"
    onclick="this.form.submit()"
    tal:attributes="
        checked python:test(specification == 'client',  'checked', None);
        tabindex tabindex/next"/>
<label i18n:translate="label_client"
    >Client</label> 

<tal:x  tal:condition="query_contact">
<tal:xx tal:define="
        address_contact python:context.reference_catalog.lookupObject(query_contact);
        client python:address_contact.aq_parent;
        contact_address python:address_contact.getPostalAddress();
        contact_address python:contact_address and contact_address or address_contact.getBillingAddress();
        contact_address python:contact_address and contact_address or client.getPostalAddress();
        contact_address python:contact_address and contact_address or client.getBillingAddress();
        contact_address python:contact_address and contact_address or address_contact.getPhysicalAddress();
        contact_address python:contact_address and contact_address or client.getPhysicalAddress()">
<div>&nbsp;<br><b><span i18n:translate="label_contact">Contact</span>:</b></div>
<div tal:content="address_contact/getFullname"></div>
<div tal:content="client/Title"></div>
<div tal:define="address python:contact_address.get('address','')"
    tal:content="structure python:modules['Products.PythonScripts.standard'].newline_to_br(address)"> </div>
<div tal:content="python:contact_address.get('city','')"></div>
<div tal:content="python:contact_address.get('state','')"></div>
<div tal:content="python:contact_address.get('zip','')"></div>
<div tal:content="python:contact_address.get('country','')"></div>
</tal:xx>
</tal:x>

<tal:y  tal:condition="python:query_client and (not query_contact)">
<tal:yy tal:define="
        address_client python:context.reference_catalog.lookupObject(query_client);
        client_address python:address_client.getPostalAddress();
        client_address python:client_address and client_address or address_client.getBillingAddress();
        client_address python:client_address and client_address or address_client.getPhysicalAddress()">
<div>&nbsp;<br><b><span i18n:translate="label_client">Client</span>:</b></div>
<div tal:content="address_client/Title"></div>
<div tal:define="address python:client_address.get('address','')"
    tal:content="structure python:modules['Products.PythonScripts.standard'].newline_to_br(address)"> </div>
<div tal:content="python:client_address.get('city','')"></div>
<div tal:content="python:client_address.get('state','')"></div>
<div tal:content="python:client_address.get('zip','')"></div>
<div tal:content="python:client_address.get('country','')"></div>
</tal:yy>
</tal:y>
<table
    class="analysisrequest"
    summary="analysis request listing"
    cellpadding="2" cellspacing="0"
    tal:condition="ar_batch"
    tal:define="service_info python:here.get_services_from_query_result(ar_batch);
                services service_info/Services;
                any_accredited service_info/Accredited"
    i18n:domain="bika">

<thead>
<tr>
<th i18n:translate="label_client_order_id">Client Order ID</th>
<tal:ar tal:repeat="ar ar_batch">
<td tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:define="global columns python:test(ar.getReportDryMatter(), columns + 2, columns + 1)"
    tal:content="python:ar.getClientOrderNumber()">123
</td>
</tal:ar>
</tr>

<tr>
<th i18n:translate="label_clientreference">Client Reference</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="python:ar.getSample().getClientReference()">R01</td>
</tr>

<tr>
<th i18n:translate="label_clientsampleid">Client Sample ID</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="python:ar.getSample().getClientSampleID()">S01</td>
</tr>
<tr>
<th i18n:translate="label_client">Client</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="ar/aq_parent/Title">Lab client</td>
</tr>

<tr>
<th i18n:translate="label_contact">Contact</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="python:ar.getContact().Title()">Fred</td>
</tr>
<tr>
<th i18n:translate="label_requestid">Request ID</th>
<td tal:repeat="ar ar_batch" 
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<a href="" tal:content="ar/getRequestID"
    tal:attributes="href ar/absolute_url">AR-00001</a>
</td>
</tr>

<tr>
<th i18n:translate="label_sampleid">Sample ID</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<a href="" tal:content="python:ar.getSample().getSampleID()"
    tal:attributes="href python:ar.getSample().absolute_url()">S-00001</a>
</td>
</tr>



<tr>
<th i18n:translate="label_arprofiles">Profile</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<span
    tal:define="profile python:ar.getProfile() and ar.getProfile().getProfileTitle() or ''"
    tal:content="profile">pr01</span>
</td>
</tr>



<tr>
<th i18n:translate="label_sampletype">Sample Type</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="python:ar.getSample().getSampleType().Title()">SampleType</td>
</tr>

<tr>
<th i18n:translate="label_samplepoint">Sample Point</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<span tal:define="samplepoint python:ar.getSample().getSamplePoint()"
    tal:content="samplepoint/Title|nothing">SamplePoint</span></td>
</tr>

<tr>
<th i18n:translate="label_datesampled">Date sampled
</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<span 
    tal:define="date_sampled python:ar.getSample().getDateSampled()"
    tal:condition="date_sampled"
    tal:content="python:plone_view.toLocalizedTime(date_sampled)">2005-01-01 10:00</span>
</td>
</tr>

<tr>
<th i18n:translate="label_daterequested">Date requested
</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="python:plone_view.toLocalizedTime(ar.getDateRequested())">2005-01-01 10:00</td>
</tr>

<tr>
<th i18n:translate="label_datereceived">Date received
</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<span 
    tal:define="date_received ar/getDateReceived|nothing"
    tal:condition="date_received"
    tal:content="python:plone_view.toLocalizedTime(date_received)">2005-01-01 10:00</span>
</td>
</tr>

<tr>
<th i18n:translate="label_datepublished">Date published
</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<span 
    tal:define="date_published ar/getDatePublished|nothing"
    tal:condition="date_published"
    tal:content="python:plone_view.toLocalizedTime(date_published)">2005-01-01 10:00</span>
</td>
</tr>

<tr>
<th i18n:translate="label_status">Status
</th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="python:here.portal_workflow.getInfoFor(ar, 'review_state', '').replace('_', ' ')">sample_due</td>
</tr>

<tr>
<th i18n:translate="label_submitted_by">Submitted by </th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1"
    tal:content="python:ar.getSample().getSubmittedByName()">Joe Splane
</td>
</tr>

<tr>
<th i18n:translate="label_verified_by">Verified by </th>
<td tal:repeat="ar ar_batch"
    tal:attributes="colspan python:ar.getReportDryMatter() and 2 or 1">
<span
    tal:define="verifier python:here.get_analysisrequest_verifier(ar)"
    tal:content="verifier">
</span>
</td>
</tr>

<tr>
<th>
<b i18n:translate="label_analysis_results">Analysis results</b>
</th>

<tal:results tal:repeat="ar ar_batch">
<tal:notdry tal:condition="not:ar/getReportDryMatter">
<th align="center">
<span tal:condition="ar/getInvoiceExclude">
<img 
    tal:define="global invoice_exclude python:1"
    src="" tal:attributes="src string:${portal/absolute_url}/no_invoice.png">
</span>
</th>
</tal:notdry>

<tal:dry tal:condition="ar/getReportDryMatter">
<th align="center">
<span tal:condition="ar/getInvoiceExclude">
<img 
    tal:define="global invoice_exclude python:1"
    src="" tal:attributes="src string:${portal/absolute_url}/no_invoice.png">
</span>
<b i18n:translate="label_as_fed">As Fed</b>
</th>
<th align="center">
<b i18n:translate="label_dry">Dry</b>
<img 
    tal:define="global dry_matter python:1"
    src="" tal:attributes="src string:${portal/absolute_url}/dry.png">
</th>
</tal:dry>
</tal:results>
</tr>

</thead>

<tbody>

<tal:service
    define="global category python:None"
    repeat="service services">
<tr tal:condition="python:service.getCategoryName() != category">
<td class="category" 
        tal:attributes="colspan python:columns + 1"
    tal:define="global category service/getCategoryName"
    tal:content="service/getCategoryName"></td>
</tr>
<tr tal:define="service_unit service/getUnit|nothing">
<th> 
<a  onClick="" title="Click for details"
    tal:attributes="onClick string:javascript:showMethod('$portal_url', '${service/getId}')"
    tal:content="service/Title">
Alcohol
</a>
<em><span
    tal:condition="service_unit"
    tal:replace="string:${service_unit}">%vol</span></em>
<img tal:condition="python:lab_accredited and service.getAccredited()"
    tal:define="global dry_matter python:1"
    src="" tal:attributes="src string:${portal/absolute_url}/accredited.png">
</th>

<tal:block repeat="ar ar_batch">
<tal:notpresent 
    tal:condition="python:service.getId() not in ar.objectIds()">
<td> </td>
<td tal:condition="ar/getReportDryMatter">
</td>
</tal:notpresent>

<tal:x condition="python:service.getId() in ar.objectIds()">
<tal:result 
    tal:define="
        service_id service/getId;
        analysis python:ar[service_id];
        result analysis/getResult|nothing;
        mou python:result and analysis.getUncertainty() or None;
        verified python:here.portal_workflow.getInfoFor(analysis, 'review_state', '') in ['verified', 'published'];
        requested python:not here.portal_workflow.getInfoFor(analysis, 'review_state', '') in ['not_requested']">

<tal:view
    tal:condition="python:(is_client and verified) or (result and requested and not is_client)">
<div tal:define="
    client_uid ar/aq_parent/UID;
    sampletype python:ar.getSample().getSampleType();
    sampletype_uid sampletype/UID;
    result_class python:here.result_in_range(analysis, sampletype_uid, specification);
    global out_of_range python:result_class == 'out_of_range' and 1 or out_of_range">
<td align="center"
      tal:attributes="class result_class;">
<span tal:content="result">10.00</span>


<em tal:condition="python:analysis.getUnit() != service_unit"
    tal:content="string:(${analysis/getUnit})"/>
<img tal:condition="python:result_class == 'out_of_range'"
    src="" tal:attributes="src string:${portal/absolute_url}/exclamation.png">
<a  onMouseover=""
    onMouseout=""
    tal:attributes="
        onMouseover string:showPopup('${service/Title}${repeat/ar/number}');
        onMouseout string:hidePopup('${service/Title}${repeat/ar/number}')"
    tal:condition="mou">
<img src="" tal:attributes="src string:${portal/absolute_url}/mou.png">
</a>
<div id=""
     class="uncertaintydiv"
     tal:attributes="id string:${service/Title}${repeat/ar/number}"
     tal:define="global any_mou python:1"
     tal:condition="mou">
<table class="uncertaintytable">
<tr>
<td tal:content="string:+/- ${mou}"/>
</tr>
</table>
</div>
<div class="retested"
      tal:condition="analysis/getRetested"
      i18n:translate="retested">retested</div>
</td>
<td tal:condition="ar/getReportDryMatter">
<span tal:condition="analysis/getResultDM"
    tal:content="analysis/getResultDM">10</span>
</td>
</div>
</tal:view>

<tal:viewnothing
    tal:condition="python:requested and not result">
<td tal:define="global tf python:1">
<img src="" tal:attributes="src string:${portal/absolute_url}/to_follow.png">
</td>
<td tal:condition="ar/getReportDryMatter">
<img src="" 
    tal:condition="service/getReportDryMatter"
    tal:attributes="src string:${portal/absolute_url}/to_follow.png">
</td>
</tal:viewnothing>

<tal:notrequested
    tal:condition="python:not requested and result">
<td tal:define="global nr python:1">
<img src="" tal:attributes="src string:${portal/absolute_url}/to_follow.png">
</td>
<td tal:condition="ar/getReportDryMatter">
<img src="" 
    tal:condition="service/getReportDryMatter"
    tal:attributes="src string:${portal/absolute_url}/to_follow.png">
</td>
</tal:notrequested>

<tal:noview
    tal:condition="python:result and requested and is_client and not verified">
<td tal:define="global tf python:1">
<img src="" tal:attributes="src string:${portal/absolute_url}/to_follow.png">
</td>
<td tal:condition="ar/getReportDryMatter">
<img src="" 
    tal:condition="service/getReportDryMatter"
    tal:attributes="src string:${portal/absolute_url}/to_follow.png">
</td>
</tal:noview>
</tal:result>
</tal:x>
</tal:block>
</tr>
</tal:service>

</tbody>

</table>

<div metal:use-macro="here/batch_macros/macros/navigation" />

<table class="analysisrequest">
<th class="tabletitle"
    colspan="2"
    i18n:translate="label_remarks">Remarks</th>
<tr tal:repeat="ar ar_batch">
<th tal:content="string:${ar/getRequestID}:">AR:</th>
<td class="left"
    tal:content="python:ar.getNotes() or default">None</td>
</tr>
</table>

<div class="discreeter">
<hr/>
<p tal:condition="out_of_range">
<img src="" tal:attributes="src string:${portal/absolute_url}/exclamation.png">
<span i18n:translate="legend_out_of_rangex">
Result out of <tal:block replace="specification" i18n:name="spec"/> specified range
</span>
</p>
<p tal:condition="dry_matter">
<img src="" tal:attributes="src string:${portal/absolute_url}/dry.png">
<span i18n:translate="disclaimer_report_dry">
Reported as dry matter</span>
</p>
<p tal:condition="tf">
<img src="" tal:attributes="src string:${portal/absolute_url}/to_follow.png">
<span i18n:translate="description_tofollow">Result to follow</span>
</p>

<p tal:condition="nr">
<img src="" tal:attributes="src string:${portal/absolute_url}/to_follow.png">
<span i18n:translate="description_notrequested">Results not requested</span>
</p>

<p tal:condition="any_mou">
<img src="" tal:attributes="src string:${portal/absolute_url}/mou.png">
<span i18n:translate="label_measure_of_uncertainty">Measure of Uncertainty</span>
</p>
<p tal:condition="invoice_exclude">
<img src="" tal:attributes="src string:${portal/absolute_url}/no_invoice.png">
<span i18n:translate="disclaimer_invoice_exclude">
Not invoiced</span>
</p>
<p tal:condition="lab_accredited">
<img src="" tal:attributes="src string:${portal/absolute_url}/accredited.png">
<span i18n:translate="disclaimer_accred">
Methods included in the <tal:block replace="here/bika_labinfo/laboratory/AccreditationBody" i18n:name="accreditation_body"/> schedule of Accreditation for this Laboratory
</span>
</p>
<hr/>
</div>


</form>
</tal:block>

</div>

</body>

</html>

