<metal:block define-macro="body">

<metal:block 
    tal:define="
        do_query python:here.REQUEST.has_key('search_form');
        b_size python:100;
        b_start python:0;
        b_start request/b_start | b_start;
        Batch python:modules['Products.CMFPlone'].Batch;">

<!-- Search form -->


<form action="" method="post" name="search"
    tal:attributes="action template/getId">

<fieldset>
<legend i18n:translate="legend_search">Search</legend>
<div class="field">
    <label i18n:translate="label_category"
        >Category</label><br/>
    <select name="getCategoryUID:ignore_empty" 
            onChange="string:document.getElementById('selectedCategoryUID').value=document.getElementById('getCategoryUID').value;document.getElementById('getServiceUID').value = '';this.form.submit()"
            style=""
            tal:attributes="
                style string:font-family:${here/base_properties/fontFamily};;font-size:100%;
                "
            id="getCategoryUID">
        <option value=""/>

        <tal:categories 
            tal:define="
        categories python:here.portal_catalog(portal_type='AnalysisCategory');
        sort_on python:(('Title', 'nocase', 'asc'),);
        categories python:sequence.sort(categories, sort_on);"
            tal:repeat="category categories">
        <option value=""
            tal:define="this_uid python:category.UID"
            tal:attributes="value this_uid;
                selected python:request.get('getCategoryUID', '') == this_uid and 'selected' or ''"
            tal:content="category/Title"
            >Acme Systems</option>

        </tal:categories>
    </select>
</div>

<div class="field">
    <label i18n:translate="label_analysisservice"
        >Analysis</label><br/>
    <select name="getServiceUID:ignore_empty" 
            onChange="string:document.getElementById('selectedServiceUID').value=document.getElementById('getServiceUID').value"
            style=""
            id="getServiceUID">
        <option value=""/>

        <tal:services
            define="    
                cat_uid python:request.get('getCategoryUID','');
                services python:cat_uid and here.portal_catalog(portal_type='AnalysisService', getCategoryUID=cat_uid, sort_on='sortable_title') or []"
            repeat="service services">
        <option value=""
            tal:attributes="value service/UID;
                selected python:request.get('getServiceUID', '')==service.UID and 'selected' or ''"
            tal:content="service/Title"
            >Alcohol</option>

        </tal:services>
    </select>
</div>

<div class="field">
    <label i18n:translate="label_client"
        >Client</label><br/>
    <select name="getClientUID:ignore_empty" 
            onChange="string:document.getElementById('selectedClientUID').value=document.getElementById('getClientUID').value"
            style=""
            id="getClientUID"
            tal:attributes="style string:font-family:${here/base_properties/fontFamily};;font-size:100%;">
        <option value=""/>

        <tal:clients
            repeat="client python:here.portal_catalog(portal_type='Client', sort_on='sortable_title')">
        <option value=""
            tal:attributes="value client/UID;
                selected python:request.get('getClientUID', '')==client.UID and 'selected' or ''"
            tal:content="client/Title"
            >Acme Systems</option>

        </tal:clients>
    </select>
</div>

</fieldset>

</form>

<form action="searchAnalyses" method="get" name="search"
    tal:attributes="action string:${here/absolute_url}/searchAnalyses">

<input type="HIDDEN" name="getCategoryUID:ignore_empty" id="selectedCategoryUID" value=""
    tal:attributes="value python:request.get('getCategoryUID','')"/>
<input type="HIDDEN" name="getServiceUID:ignore_empty" id="selectedServiceUID" value=""
    tal:attributes="value python:request.get('getServiceUID','')"/>
<input type="HIDDEN" name="getClientUID:ignore_empty" id="selectedClientUID" value=""
    tal:attributes="value python:request.get('getClientUID','')"/>

<input type="HIDDEN" name="search_form" id="" value="search"/>
<div class="field">
    <input tabindex=""
        class="searchButton"
        type="submit"
        name="submit"
        value="Search"
        i18n:attributes="value"
        />                       
</div>


</form>

<!-- actual list of objects, either searchresults or folder contents -->

<tal:query tal:condition="do_query">
<tal:block 
    tal:define="
        query_results python:here.get_worksheet_query_results()">
<div tal:condition="query_results">
<h2 i18n:translate="heading_search_results">Search results</h2>
</div>

<!-- object list -->
<tal:noresults tal:condition="python:len(query_results)==0">
<p i18n:translate="no_items_found">No items found.</p>
</tal:noresults>

<tal:list tal:define="
    checkPermission python: here.portal_membership.checkPermission;
    batch python: Batch(query_results, b_size, int(b_start), orphan=1);">
<form action="assignUnnumberedAnalyses" method="post"
    tal:attributes="action string:${here/absolute_url}/assignUnnumberedAnalyses">
<table
    class="listing" 
    cellspacing="0" 
    cellpadding="5"
    tal:condition="batch">
<thead>
<tr>
<th class="nosort"><input
    class="noborder"
    type="checkbox"
    src="select_all_icon.gif"
    name="selectButton"
    title="Select all items"
    onClick="toggleSelect(this, 'Analyses:list');"
    tal:attributes="src string:$portal_url/select_all_icon.gif"
    alt="Select all items"
    i18n:attributes="title; alt"
    />
</th>
<th i18n:translate="label_client">Client</th>
<th i18n:translate="label_client_order">Order</th>
<th i18n:translate="label_request_id">Request ID</th>
<th i18n:translate="label_category">Category</th>
<th i18n:translate="label_analysis">Analysis</th>
<th i18n:translate="label_datereceived">Date Received</th>
<th i18n:translate="label_due">Due</th>
</tr>
</thead>
<tbody>
<tal:results tal:repeat="obj batch">
<tr tal:define="
    oddrow repeat/obj/odd"
    tal:attributes="class python:test(oddrow, 'even', 'odd')">
<td>
<input type="checkbox" class="noborder" name="Analyses:list" value="#"
    tal:attributes="value obj/UID"/>
</td>
<tal:parents 
    tal:define="ar nocall:obj/aq_parent;
                client nocall:ar/aq_parent">
<td tal:content="client/Title"/>
<td tal:content="ar/getClientOrderNumber"/>
<td><a href="#"
    tal:attributes="href ar/absolute_url"
    tal:content="ar/id">AR-00001</a>
</td>
<td tal:content="python:obj.getService().getCategoryName()"/>
<td tal:content="obj/Title"/>
<td tal:define="d python:ar.getDateReceived()"
    tal:content="python:plone_view.toLocalizedTime(d, long_format=1)"/>
</tal:parents>
<td tal:define="d obj/getDueDate"
    tal:content="python:plone_view.toLocalizedTime(d, long_format=1)"/>
</tr>
</tal:results>
</tbody>
</table>

<input
    class="context"
    type="submit"
    name=""
    value="Add to worksheet"
    tal:condition="batch"
    i18n:attributes="value"/>
</form>

<div metal:use-macro="here/batch_macros/macros/navigation" />
</tal:list>
</tal:block>
</tal:query>


</metal:block>
</metal:block>

